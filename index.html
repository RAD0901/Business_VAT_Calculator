<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAT Calculator Pro - Transform Excel VAT into Professional Reports</title>
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iOCIgZmlsbD0idXJsKCNncmFkaWVudDApIi8+CjxwYXRoIGQ9Ik04IDE2SDE2TDEyIDhWMTZaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMTYgMTZIMjRMMjAgMjRWMTZaIiBmaWxsPSJ3aGl0ZSIvPgo8ZGVmcz4KPGxpbmVhckdyYWRpZW50IGlkPSJncmFkaWVudDAiIHgxPSIwIiB5MT0iMCIgeDI9IjMyIiB5Mj0iMzIiIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIj4KPHN0b3Agc3RvcC1jb2xvcj0iIzY2N0VFQSIvPgo8c3RvcCBvZmZzZXQ9IjEiIHN0b3AtY29sb3I9IiM3NjRCQTIiLz4KPC9saW5lYXJHcmFkaWVudD4KPC9kZWZzPgo8L3N2Zz4K">
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --neutral-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --input-gradient: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            --output-gradient: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            
            --text-primary: #2d3748;
            --text-secondary: #4a5568;
            --text-light: #718096;
            --background: #f7fafc;
            --white: #ffffff;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --border-radius: 12px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        .header {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 1rem 0;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
            list-style: none;
        }

        .nav-link {
            color: var(--white);
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: var(--transition);
            font-weight: 500;
        }

        .nav-link:hover,
        .nav-link.active {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Main Content */
        .main-content {
            min-height: calc(100vh - 80px);
            padding: 2rem 0;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Card Components */
        .card {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 2rem;
            margin-bottom: 2rem;
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .card-gradient {
            background: var(--primary-gradient);
            color: var(--white);
        }

        /* Button Components */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            min-height: 48px;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: var(--white);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-lg {
            padding: 1rem 2rem;
            font-size: 1.1rem;
            min-height: 56px;
        }

        .btn-block {
            width: 100%;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #718096 0%, #4a5568 100%);
            color: var(--white);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Hero Enhancements */
        .hero-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Mobile Menu */
        .mobile-menu-toggle {
            display: none;
            flex-direction: column;
            cursor: pointer;
            gap: 4px;
        }

        .mobile-menu-toggle span {
            width: 25px;
            height: 3px;
            background: var(--white);
            border-radius: 2px;
            transition: var(--transition);
        }

        /* Breadcrumb Navigation */
        .breadcrumb {
            padding: 1rem 0;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .breadcrumb a {
            color: #667eea;
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        /* Page Headers */
        .page-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .page-header h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .page-header p {
            font-size: 1.1rem;
            color: var(--text-secondary);
        }

        /* Comparison Table */
        .comparison-section {
            margin: 4rem 0;
            text-align: center;
        }

        .comparison-section h2 {
            margin-bottom: 2rem;
            font-size: 2rem;
            color: var(--text-primary);
        }

        .comparison-table {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            max-width: 800px;
            margin: 0 auto;
        }

        .comparison-header {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            background: var(--primary-gradient);
            color: var(--white);
        }

        .comparison-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            border-bottom: 1px solid var(--border);
        }

        .comparison-row:last-child {
            border-bottom: none;
        }

        .comparison-item {
            padding: 1rem;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .comparison-item.excel {
            background: rgba(255, 107, 107, 0.1);
            color: #e53e3e;
        }

        .comparison-item.vat-pro {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        /* Testimonials */
        .testimonials-section {
            margin: 4rem 0;
            text-align: center;
        }

        .testimonials-section h2 {
            margin-bottom: 2rem;
            font-size: 2rem;
            color: var(--text-primary);
        }

        .testimonials-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .testimonial-card {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 2rem;
            transition: var(--transition);
        }

        .testimonial-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .testimonial-content {
            margin-bottom: 1.5rem;
            font-style: italic;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .testimonial-author {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .author-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 1.2rem;
        }

        .author-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .author-title {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        /* FAQ Section */
        .faq-section {
            margin: 4rem 0;
        }

        .faq-section h2 {
            text-align: center;
            margin-bottom: 2rem;
            font-size: 2rem;
            color: var(--text-primary);
        }

        .faq-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
        }

        .faq-item {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            transition: var(--transition);
        }

        .faq-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .faq-item h3 {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .faq-item p {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .faq-item a {
            color: #667eea;
            text-decoration: none;
        }

        .faq-item a:hover {
            text-decoration: underline;
        }

        /* Demo Page Styles */
        .demo-section {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 2rem;
            align-items: center;
            margin: 3rem 0;
        }

        .demo-preview, .demo-results {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 2rem;
        }

        .demo-arrow {
            font-size: 2rem;
            color: #667eea;
            font-weight: bold;
        }

        .excel-preview {
            margin-top: 1rem;
        }

        .demo-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }

        .demo-table th,
        .demo-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .demo-table th {
            background: var(--primary-gradient);
            color: var(--white);
            font-weight: 600;
        }

        .demo-note {
            font-size: 0.9rem;
            color: var(--text-light);
            font-style: italic;
        }

        .demo-results-grid {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }

        .demo-result-card {
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .demo-result-card.output {
            background: var(--output-gradient);
            color: var(--white);
        }

        .demo-result-card.input {
            background: var(--input-gradient);
            color: var(--white);
        }

        .demo-result-card.payable {
            background: var(--primary-gradient);
            color: var(--white);
        }

        .result-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        .result-amount {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .demo-steps {
            margin: 3rem 0;
        }

        .demo-steps h2 {
            text-align: center;
            margin-bottom: 2rem;
            color: var(--text-primary);
        }

        .steps-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
        }

        .demo-step {
            text-align: center;
            padding: 2rem;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .demo-step:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .step-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 1rem;
            background: var(--primary-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 1.5rem;
            font-weight: bold;
        }

        .demo-cta {
            text-align: center;
            margin: 3rem 0;
        }

        /* Help Page Styles */
        .help-sections {
            display: flex;
            flex-direction: column;
            gap: 3rem;
        }

        .help-section {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .help-section h2 {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 1.5rem 2rem;
            margin: 0;
        }

        .help-content {
            padding: 2rem;
        }

        .requirements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .requirement-item h3 {
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .requirement-item ul {
            list-style: none;
            padding: 0;
        }

        .requirement-item li {
            padding: 0.5rem 0;
            position: relative;
            padding-left: 1.5rem;
        }

        .requirement-item li:before {
            content: "•";
            position: absolute;
            left: 0;
            color: #667eea;
            font-weight: bold;
        }

        .trcode-tables {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .trcode-table h3 {
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .reference-table {
            width: 100%;
            border-collapse: collapse;
        }

        .reference-table th,
        .reference-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .reference-table th {
            background: rgba(102, 126, 234, 0.1);
            color: var(--text-primary);
            font-weight: 600;
        }

        .troubleshooting-items {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .trouble-item {
            padding: 1.5rem;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .trouble-item h3 {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .video-placeholder {
            text-align: center;
            padding: 3rem;
            background: rgba(102, 126, 234, 0.05);
            border-radius: var(--border-radius);
            border: 2px dashed #667eea;
        }

        .video-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .video-note {
            color: var(--text-light);
            font-style: italic;
        }

        .support-form {
            max-width: 500px;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: inherit;
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* About Page Styles */
        .about-sections {
            display: flex;
            flex-direction: column;
            gap: 3rem;
        }

        .about-section {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .about-section h2 {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 1.5rem 2rem;
            margin: 0;
        }

        .about-content {
            padding: 2rem;
        }

        .benefits-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .benefit-item {
            padding: 1.5rem;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 8px;
            text-align: center;
        }

        .benefit-item h3 {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .privacy-highlights {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .privacy-item {
            padding: 1.5rem;
            background: rgba(16, 185, 129, 0.05);
            border-radius: 8px;
            border-left: 4px solid #10b981;
        }

        .privacy-item h3 {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .terms-content h3 {
            color: var(--text-primary);
            margin: 1.5rem 0 0.5rem 0;
        }

        .terms-content h3:first-child {
            margin-top: 0;
        }

        .contact-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .contact-item {
            padding: 1.5rem;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 8px;
            text-align: center;
        }

        .contact-item h3 {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .security-features h3 {
            color: var(--text-primary);
            margin: 1.5rem 0 0.5rem 0;
        }

        .security-features h3:first-child {
            margin-top: 0;
        }

        .security-features ul {
            list-style: none;
            padding: 0;
        }

        .security-features li {
            padding: 0.5rem 0;
            position: relative;
            padding-left: 1.5rem;
        }

        .security-features li:before {
            content: "✓";
            position: absolute;
            left: 0;
            color: #10b981;
            font-weight: bold;
        }

        /* Footer */
        .footer {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            color: var(--white);
            margin-top: 4rem;
            padding: 3rem 0 1rem;
        }

        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .footer-logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .footer-section h4 {
            margin-bottom: 1rem;
            color: var(--white);
        }

        .footer-section ul {
            list-style: none;
            padding: 0;
        }

        .footer-section li {
            padding: 0.25rem 0;
        }

        .footer-section a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: var(--transition);
        }

        .footer-section a:hover {
            color: var(--white);
            text-decoration: underline;
        }

        .footer-bottom {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 1rem;
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Export Toolbar Styles */
        .export-toolbar {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .export-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .export-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn-export {
            padding: 0.75rem 1rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .btn-export.pdf {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: var(--white);
        }

        .btn-export.excel {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            color: var(--white);
        }

        .btn-export.email {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: var(--white);
        }

        .btn-export.print {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            color: var(--white);
        }

        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: var(--white);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Settings Page Styles */
        .settings-sections {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .settings-section {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .settings-section h2 {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 1.5rem 2rem;
            margin: 0;
        }

        .settings-content {
            padding: 2rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .file-upload-area {
            border: 2px dashed var(--border);
            border-radius: var(--border-radius);
            padding: 2rem;
            text-align: center;
            transition: var(--transition);
            cursor: pointer;
        }

        .file-upload-area:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .upload-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .upload-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 1.5rem;
        }

        .mapping-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .mapping-section h3 {
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .code-list {
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .code-items {
            max-height: 200px;
            overflow-y: auto;
        }

        .code-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            background: var(--white);
        }

        .code-item:last-child {
            border-bottom: none;
        }

        .code-item.input {
            background: rgba(255, 107, 107, 0.05);
        }

        .code-item.output {
            background: rgba(116, 185, 255, 0.05);
        }

        .code-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .code-remove {
            background: none;
            border: none;
            color: #dc2626;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: var(--transition);
        }

        .code-remove:hover {
            background: rgba(220, 38, 38, 0.1);
        }

        .add-code {
            display: flex;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.02);
            gap: 0.5rem;
        }

        .add-code input {
            flex: 1;
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.5rem;
        }

        .mapping-actions {
            margin-top: 1.5rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .preferences-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .preference-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .preference-group label {
            font-weight: 600;
            color: var(--text-primary);
        }

        .preference-group select {
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: inherit;
            background: var(--white);
        }

        .storage-options {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .storage-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .danger-zone {
            margin-top: 2rem;
            padding: 1.5rem;
            background: rgba(220, 38, 38, 0.05);
            border: 1px solid rgba(220, 38, 38, 0.2);
            border-radius: var(--border-radius);
        }

        .danger-zone h3 {
            color: #dc2626;
            margin-bottom: 0.5rem;
        }

        .danger-actions {
            margin-top: 1rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .settings-actions {
            text-align: center;
            margin: 3rem 0;
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* History Page Styles */
        .history-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 1.5rem;
        }

        .stat-content {
            flex: 1;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .comparison-section {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 2rem;
            margin-bottom: 3rem;
        }

        .comparison-section h2 {
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }

        .comparison-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 2rem;
        }

        .comparison-controls select {
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            min-width: 200px;
        }

        .vs-text {
            font-weight: 600;
            color: var(--text-secondary);
            padding: 0 0.5rem;
        }

        .comparison-results {
            padding: 1.5rem;
            background: rgba(102, 126, 234, 0.05);
            border-radius: var(--border-radius);
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .history-list-section {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .history-header {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .history-header h2 {
            margin: 0;
        }

        .history-actions {
            display: flex;
            gap: 0.5rem;
        }

        .history-filters {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .history-filters input {
            flex: 1;
            min-width: 250px;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
        }

        .history-filters select {
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
        }

        .history-list {
            padding: 1rem;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            background: var(--white);
            transition: var(--transition);
        }

        .history-item:hover {
            box-shadow: var(--shadow);
            transform: translateY(-1px);
        }

        .history-info {
            flex: 1;
        }

        .history-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .history-meta {
            font-size: 0.9rem;
            color: var(--text-secondary);
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .history-amount {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-right: 1rem;
        }

        .history-actions-item {
            display: flex;
            gap: 0.5rem;
        }

        .btn-icon {
            padding: 0.5rem;
            border: none;
            border-radius: 6px;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-icon:hover {
            background: rgba(102, 126, 234, 0.2);
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 100px;
            right: 20px;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            padding: 1rem 1.5rem;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            border-left: 4px solid #10b981;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            border-left-color: #dc2626;
        }

        .toast.warning {
            border-left-color: #f59e0b;
        }

        /* Print Styles */
        @media print {
            .header, .footer, .export-toolbar, .breadcrumb {
                display: none !important;
            }
            
            .main-content {
                padding: 0 !important;
            }
            
            .page {
                box-shadow: none !important;
                border: none !important;
            }
            
            .results-summary {
                grid-template-columns: repeat(2, 1fr) !important;
            }
            
            .breakdown-section {
                page-break-inside: avoid;
            }
        }

        /* Landing Page */
        .hero {
            text-align: center;
            padding: 4rem 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--white);
            margin: -2rem -20px 3rem -20px;
            border-radius: 0 0 2rem 2rem;
        }

        .hero h1 {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 1rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .hero p {
            font-size: 1.2rem;
            margin-bottom: 2rem;
            opacity: 0.9;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin: 3rem 0;
        }

        .feature-card {
            text-align: center;
            padding: 2rem;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .feature-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .feature-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 1rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .feature-card:nth-child(1) .feature-icon {
            background: var(--success-gradient);
            color: white;
        }

        .feature-card:nth-child(2) .feature-icon {
            background: var(--warning-gradient);
            color: white;
        }

        .feature-card:nth-child(3) .feature-icon {
            background: var(--secondary-gradient);
            color: white;
        }

        .feature-card:nth-child(4) .feature-icon {
            background: var(--neutral-gradient);
            color: white;
        }

        /* Upload Page */
        .upload-zone {
            border: 3px dashed var(--border);
            border-radius: var(--border-radius);
            padding: 3rem;
            text-align: center;
            background: var(--white);
            transition: var(--transition);
            cursor: pointer;
            margin: 2rem 0;
        }

        .upload-zone:hover,
        .upload-zone.dragover {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
        }

        .upload-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 1rem;
            background: var(--primary-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 2rem;
        }

        .file-input {
            display: none;
        }

        .file-requirements {
            background: #f8f9fa;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin: 2rem 0;
        }

        .file-requirements h3 {
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .file-requirements ul {
            list-style: none;
            padding: 0;
        }

        .file-requirements li {
            padding: 0.5rem 0;
            position: relative;
            padding-left: 1.5rem;
        }

        .file-requirements li:before {
            content: "✓";
            position: absolute;
            left: 0;
            color: #10b981;
            font-weight: bold;
        }

        .file-status {
            margin: 1rem 0;
            padding: 1rem;
            border-radius: var(--border-radius);
            display: none;
        }

        .file-status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .file-status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        /* Processing Page */
        .processing-container {
            max-width: 600px;
            margin: 0 auto;
            text-align: center;
        }

        .progress-steps {
            margin: 3rem 0;
        }

        .progress-step {
            display: flex;
            align-items: center;
            margin: 2rem 0;
            padding: 1rem;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .progress-step.active {
            background: var(--primary-gradient);
            color: var(--white);
            transform: scale(1.02);
        }

        .progress-step.completed {
            background: var(--success-gradient);
            color: var(--white);
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 1rem;
        }

        .progress-step:not(.active):not(.completed) .step-number {
            background: var(--border);
            color: var(--text-light);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
            margin: 2rem 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-gradient);
            width: 0%;
            transition: width 0.5s ease;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            margin: 2rem auto;
            border: 4px solid var(--border);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Results Page */
        .results-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .summary-card {
            padding: 1.5rem;
            border-radius: var(--border-radius);
            color: var(--white);
            text-align: center;
            transition: var(--transition);
        }

        .summary-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .summary-card.output-vat {
            background: var(--output-gradient);
        }

        .summary-card.input-vat {
            background: var(--input-gradient);
        }

        .summary-card.sales-incl {
            background: var(--neutral-gradient);
        }

        .summary-card.sales-excl {
            background: var(--warning-gradient);
        }

        .summary-card.zero-rated {
            background: var(--success-gradient);
        }

        .summary-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        .summary-amount {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .vat-payable {
            background: var(--primary-gradient);
            color: var(--white);
            text-align: center;
            padding: 2rem;
            border-radius: var(--border-radius);
            margin: 2rem 0;
            box-shadow: var(--shadow-lg);
        }

        .vat-payable h2 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .vat-payable .amount {
            font-size: 3rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .breakdown-section {
            margin: 3rem 0;
        }

        .breakdown-header {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 1rem 2rem;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            margin-bottom: 0;
        }

        .breakdown-content {
            background: var(--white);
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            box-shadow: var(--shadow);
            padding: 0;
        }

        .input-output-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
        }

        .input-section {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.1) 0%, rgba(238, 90, 36, 0.1) 100%);
            padding: 1.5rem;
            border-right: 1px solid var(--border);
        }

        .output-section {
            background: linear-gradient(135deg, rgba(116, 185, 255, 0.1) 0%, rgba(9, 132, 227, 0.1) 100%);
            padding: 1.5rem;
        }

        .section-title {
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .input-section .section-title {
            color: #e53e3e;
        }

        .output-section .section-title {
            color: #3182ce;
        }

        .stat-grid {
            display: grid;
            gap: 0.5rem;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .stat-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .sample-transactions {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        .sample-transactions h4 {
            margin-bottom: 1rem;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .transaction-table {
            width: 100%;
            font-size: 0.8rem;
            border-collapse: collapse;
        }

        .transaction-table th,
        .transaction-table td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .transaction-table th {
            background: rgba(0, 0, 0, 0.02);
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 0 16px;
            }

            .hero {
                margin: -2rem -16px 2rem -16px;
                padding: 2rem 1rem;
            }

            .hero h1 {
                font-size: 2rem;
            }

            .hero p {
                font-size: 1rem;
            }

            .hero-buttons {
                flex-direction: column;
                align-items: center;
            }

            .features-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .results-summary {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .input-output-grid {
                grid-template-columns: 1fr;
            }

            .input-section {
                border-right: none;
                border-bottom: 1px solid var(--border);
            }

            .vat-payable .amount {
                font-size: 2rem;
            }

            .nav-links {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: var(--primary-gradient);
                flex-direction: column;
                padding: 1rem;
                box-shadow: var(--shadow);
            }

            .nav-links.show {
                display: flex;
            }

            .mobile-menu-toggle {
                display: flex;
            }

            .comparison-table,
            .comparison-header,
            .comparison-row {
                grid-template-columns: 1fr;
            }

            .comparison-item {
                border-bottom: 1px solid var(--border);
            }

            .testimonials-grid {
                grid-template-columns: 1fr;
            }

            .faq-grid {
                grid-template-columns: 1fr;
            }

            .demo-section {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .demo-arrow {
                transform: rotate(90deg);
                justify-self: center;
            }

            .steps-grid {
                grid-template-columns: 1fr;
            }

            .requirements-grid,
            .trcode-tables,
            .benefits-grid,
            .privacy-highlights,
            .contact-grid {
                grid-template-columns: 1fr;
            }

            .footer-content {
                grid-template-columns: 1fr;
                text-align: center;
            }

            .page-header h1 {
                font-size: 2rem;
            }
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .mb-0 { margin-bottom: 0; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mt-3 { margin-top: 1.5rem; }
        .hidden { display: none; }
        .block { display: block; }

        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Error States */
        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 1rem;
            border-radius: var(--border-radius);
            border: 1px solid #fca5a5;
            margin: 1rem 0;
        }

        .success-message {
            background: #d1fae5;
            color: #065f46;
            padding: 1rem;
            border-radius: var(--border-radius);
            border: 1px solid #a7f3d0;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">V</div>
                    VAT Calculator Pro
                </div>
                <nav>
                    <ul class="nav-links">
                        <li><a href="#/" class="nav-link active" data-page="landing">Home</a></li>
                        <li><a href="#/demo" class="nav-link" data-page="demo">Demo</a></li>
                        <li><a href="#/upload" class="nav-link" data-page="upload">Upload</a></li>
                        <li><a href="#/help" class="nav-link" data-page="help">Help</a></li>
                        <li><a href="#/about" class="nav-link" data-page="about">About</a></li>
                        <li><a href="#/settings" class="nav-link" data-page="settings">Settings</a></li>
                        <li><a href="#/history" class="nav-link" data-page="history">History</a></li>
                    </ul>
                    <div class="mobile-menu-toggle" onclick="toggleMobileMenu()">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Landing Page -->
            <div id="landing-page" class="page active">
                <section class="hero">
                    <h1>Transform Excel VAT into Professional Reports</h1>
                    <p>Save 90% of your VAT calculation time with automated processing and professional reporting. Upload your Excel file and get instant, SARS-compliant VAT calculations.</p>
                    <div class="hero-buttons">
                        <button class="btn btn-primary btn-lg" onclick="navigateToPage('upload')">
                            📊 Start Calculating
                        </button>
                        <button class="btn btn-secondary btn-lg" onclick="navigateToPage('demo')">
                            🎯 See Demo
                        </button>
                    </div>
                </section>

                <!-- Comparison Table -->
                <section class="comparison-section">
                    <h2>Why Choose VAT Calculator Pro?</h2>
                    <div class="comparison-table">
                        <div class="comparison-header">
                            <div class="comparison-item">Feature</div>
                            <div class="comparison-item excel">Traditional Excel</div>
                            <div class="comparison-item vat-pro">VAT Calculator Pro</div>
                        </div>
                        <div class="comparison-row">
                            <div class="comparison-item">Processing Time</div>
                            <div class="comparison-item excel">2-3 Hours</div>
                            <div class="comparison-item vat-pro">2-3 Minutes</div>
                        </div>
                        <div class="comparison-row">
                            <div class="comparison-item">Error Rate</div>
                            <div class="comparison-item excel">15-20%</div>
                            <div class="comparison-item vat-pro">0%</div>
                        </div>
                        <div class="comparison-row">
                            <div class="comparison-item">Report Quality</div>
                            <div class="comparison-item excel">Basic Tables</div>
                            <div class="comparison-item vat-pro">Professional Design</div>
                        </div>
                        <div class="comparison-row">
                            <div class="comparison-item">SARS Compliance</div>
                            <div class="comparison-item excel">Manual Verification</div>
                            <div class="comparison-item vat-pro">Guaranteed</div>
                        </div>
                    </div>
                </section>

                <!-- Features Grid -->
                <div class="features-grid">
                    <div class="feature-card">
                        <div class="feature-icon">⚡</div>
                        <h3>Automatic Calculations</h3>
                        <p>Instantly process thousands of transactions and automatically categorize INPUT and OUTPUT VAT with 100% accuracy.</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">📋</div>
                        <h3>Professional Reports</h3>
                        <p>Generate modern, visually appealing VAT reports that look professional for stakeholders and compliance.</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">✅</div>
                        <h3>SARS Compliant</h3>
                        <p>Ensure complete compliance with South African Revenue Service requirements and tax code classifications.</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">🔒</div>
                        <h3>Secure & Private</h3>
                        <p>All processing happens in your browser. Your data never leaves your device - complete privacy guaranteed.</p>
                    </div>
                </div>

                <!-- Testimonials Section -->
                <section class="testimonials-section">
                    <h2>What Our Customers Say</h2>
                    <div class="testimonials-grid">
                        <div class="testimonial-card">
                            <div class="testimonial-content">
                                <p>"This tool has revolutionized our VAT processing. What used to take hours now takes minutes, and the professional reports impress our clients every time."</p>
                            </div>
                            <div class="testimonial-author">
                                <div class="author-avatar">📊</div>
                                <div class="author-info">
                                    <div class="author-name">Sarah Mitchell</div>
                                    <div class="author-title">Small Business Owner</div>
                                </div>
                            </div>
                        </div>
                        <div class="testimonial-card">
                            <div class="testimonial-content">
                                <p>"We've processed over 500 VAT returns using this calculator. The accuracy is perfect and our clients love the professional presentation."</p>
                            </div>
                            <div class="testimonial-author">
                                <div class="author-avatar">🏢</div>
                                <div class="author-info">
                                    <div class="author-name">David Chen</div>
                                    <div class="author-title">Accounting Firm Partner</div>
                                </div>
                            </div>
                        </div>
                        <div class="testimonial-card">
                            <div class="testimonial-content">
                                <p>"Finally, a tool that makes VAT calculations simple! The interface is intuitive and the results are always accurate. Highly recommended!"</p>
                            </div>
                            <div class="testimonial-author">
                                <div class="author-avatar">💼</div>
                                <div class="author-info">
                                    <div class="author-name">Lisa Thompson</div>
                                    <div class="author-title">Professional Bookkeeper</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- FAQ Section -->
                <section class="faq-section">
                    <h2>Frequently Asked Questions</h2>
                    <div class="faq-grid">
                        <div class="faq-item">
                            <h3>What Excel format do I need?</h3>
                            <p>Upload any .xlsx or .xls file with the required columns: TaxCode, TaxDescription, TrCode, TaxRate, TaxAmount, ExclAmount, and InclAmount.</p>
                        </div>
                        <div class="faq-item">
                            <h3>Is my data secure?</h3>
                            <p>Absolutely! All processing happens entirely in your browser. Your data never leaves your device or gets uploaded to any server.</p>
                        </div>
                        <div class="faq-item">
                            <h3>What if I get calculation errors?</h3>
                            <p>Our system validates all data and provides clear error messages. Check our help page for common solutions or contact support.</p>
                        </div>
                        <div class="faq-item">
                            <h3>Can I customize transaction codes?</h3>
                            <p>The system uses standard SARS transaction codes (CASH, INV, IS, etc.). Custom codes may not be recognized but can be manually categorized.</p>
                        </div>
                        <div class="faq-item">
                            <h3>How accurate are the calculations?</h3>
                            <p>Our calculations are 100% accurate and follow exact SARS guidelines. The system has been tested with thousands of real VAT returns.</p>
                        </div>
                        <div class="faq-item">
                            <h3>Need more help?</h3>
                            <p>Visit our <a href="#/help" onclick="navigateToPage('help')">help page</a> for detailed guides or try our <a href="#/demo" onclick="navigateToPage('demo')">interactive demo</a>.</p>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Demo Page -->
            <div id="demo-page" class="page">
                <nav class="breadcrumb">
                    <a href="#/" onclick="navigateToPage('landing')">Home</a> > Demo
                </nav>
                <div class="page-header">
                    <h1>Interactive Demo</h1>
                    <p>See VAT Calculator Pro in action with sample data</p>
                </div>

                <div class="demo-section">
                    <div class="demo-preview">
                        <h2>Sample Excel Data Preview</h2>
                        <div class="excel-preview">
                            <table class="demo-table">
                                <thead>
                                    <tr>
                                        <th>TaxCode</th>
                                        <th>TrCode</th>
                                        <th>TaxAmount</th>
                                        <th>ExclAmount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>1</td>
                                        <td>INV</td>
                                        <td>150.00</td>
                                        <td>1000.00</td>
                                    </tr>
                                    <tr>
                                        <td>1</td>
                                        <td>CASH</td>
                                        <td>75.00</td>
                                        <td>500.00</td>
                                    </tr>
                                    <tr>
                                        <td>3</td>
                                        <td>IS</td>
                                        <td>0.00</td>
                                        <td>2000.00</td>
                                    </tr>
                                </tbody>
                            </table>
                            <p class="demo-note">Sample showing 3 of 3,723 transactions</p>
                        </div>
                    </div>

                    <div class="demo-arrow">→</div>

                    <div class="demo-results">
                        <h2>Expected Results</h2>
                        <div class="demo-results-grid">
                            <div class="demo-result-card output">
                                <div class="result-label">Output VAT</div>
                                <div class="result-amount">R 1,384,201.12</div>
                            </div>
                            <div class="demo-result-card input">
                                <div class="result-label">Input VAT</div>
                                <div class="result-amount">R 250,571.49</div>
                            </div>
                            <div class="demo-result-card payable">
                                <div class="result-label">VAT Payable</div>
                                <div class="result-amount">R 1,133,629.63</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="demo-steps">
                    <h2>How It Works</h2>
                    <div class="steps-grid">
                        <div class="demo-step">
                            <div class="step-icon">1</div>
                            <h3>Upload Excel File</h3>
                            <p>Drag and drop your VAT Excel file or click to browse. Files up to 50MB supported.</p>
                        </div>
                        <div class="demo-step">
                            <div class="step-icon">2</div>
                            <h3>Automatic Processing</h3>
                            <p>Our system reads your data, validates columns, and categorizes transactions automatically.</p>
                        </div>
                        <div class="demo-step">
                            <div class="step-icon">3</div>
                            <h3>Instant Results</h3>
                            <p>Get professional VAT calculations with detailed breakdowns in seconds.</p>
                        </div>
                        <div class="demo-step">
                            <div class="step-icon">4</div>
                            <h3>Professional Report</h3>
                            <p>View beautifully formatted results ready for stakeholders and SARS compliance.</p>
                        </div>
                    </div>
                </div>

                <div class="demo-cta">
                    <button class="btn btn-primary btn-lg" onclick="navigateToPage('upload')">
                        📊 Try With Your Own Data
                    </button>
                </div>
            </div>

            <!-- Help Page -->
            <div id="help-page" class="page">
                <nav class="breadcrumb">
                    <a href="#/" onclick="navigateToPage('landing')">Home</a> > Help
                </nav>
                <div class="page-header">
                    <h1>Help & Support</h1>
                    <p>Everything you need to know about using VAT Calculator Pro</p>
                </div>

                <div class="help-sections">
                    <div class="help-section">
                        <h2>Excel File Requirements</h2>
                        <div class="help-content">
                            <div class="requirements-grid">
                                <div class="requirement-item">
                                    <h3>Supported Formats</h3>
                                    <ul>
                                        <li>Microsoft Excel (.xlsx)</li>
                                        <li>Excel 97-2003 (.xls)</li>
                                        <li>Maximum size: 50MB</li>
                                    </ul>
                                </div>
                                <div class="requirement-item">
                                    <h3>Required Columns</h3>
                                    <ul>
                                        <li><strong>TaxCode</strong> - Tax classification (1, 3, or 5)</li>
                                        <li><strong>TaxDescription</strong> - Description of tax type</li>
                                        <li><strong>TrCode</strong> - Transaction code</li>
                                        <li><strong>TaxRate</strong> - Tax percentage rate</li>
                                        <li><strong>TaxAmount</strong> - VAT amount in Rands</li>
                                        <li><strong>ExclAmount</strong> - Amount excluding VAT</li>
                                        <li><strong>InclAmount</strong> - Amount including VAT</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="help-section">
                        <h2>Transaction Code Reference</h2>
                        <div class="help-content">
                            <div class="trcode-tables">
                                <div class="trcode-table">
                                    <h3>INPUT VAT Codes (Purchases)</h3>
                                    <table class="reference-table">
                                        <thead>
                                            <tr><th>Code</th><th>Description</th></tr>
                                        </thead>
                                        <tbody>
                                            <tr><td>CASH</td><td>Cash purchases</td></tr>
                                            <tr><td>JC</td><td>Journal credit</td></tr>
                                            <tr><td>JNL</td><td>Journal entry</td></tr>
                                            <tr><td>SINV</td><td>Supplier invoice</td></tr>
                                            <tr><td>JD</td><td>Journal debit</td></tr>
                                            <tr><td>RC</td><td>Receipt</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="trcode-table">
                                    <h3>OUTPUT VAT Codes (Sales)</h3>
                                    <table class="reference-table">
                                        <thead>
                                            <tr><th>Code</th><th>Description</th></tr>
                                        </thead>
                                        <tbody>
                                            <tr><td>IS</td><td>Invoice sale</td></tr>
                                            <tr><td>INV</td><td>Invoice</td></tr>
                                            <tr><td>RTS</td><td>Receipt sale</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="help-section">
                        <h2>Troubleshooting</h2>
                        <div class="help-content">
                            <div class="troubleshooting-items">
                                <div class="trouble-item">
                                    <h3>🚫 "Missing required columns" error</h3>
                                    <p><strong>Solution:</strong> Ensure your Excel file has all required column headers exactly as specified. Column names are case-sensitive.</p>
                                </div>
                                <div class="trouble-item">
                                    <h3>🚫 "Invalid file format" error</h3>
                                    <p><strong>Solution:</strong> Save your file in .xlsx or .xls format. CSV files are not supported.</p>
                                </div>
                                <div class="trouble-item">
                                    <h3>🚫 "File too large" error</h3>
                                    <p><strong>Solution:</strong> Reduce file size by removing unnecessary columns or splitting into smaller files. Maximum size is 50MB.</p>
                                </div>
                                <div class="trouble-item">
                                    <h3>🚫 Unexpected calculation results</h3>
                                    <p><strong>Solution:</strong> Check that TrCodes match our reference table and TaxCodes are 1, 3, or 5. Unknown codes are skipped.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="help-section">
                        <h2>Sample Template</h2>
                        <div class="help-content">
                            <p>Download our sample Excel template to see the correct format:</p>
                            <button class="btn btn-secondary" onclick="downloadSampleTemplate()">
                                📁 Download Sample Template
                            </button>
                        </div>
                    </div>

                    <div class="help-section">
                        <h2>Video Tutorial</h2>
                        <div class="help-content">
                            <div class="video-placeholder">
                                <div class="video-icon">▶️</div>
                                <p>Step-by-step video tutorial</p>
                                <p class="video-note">Coming soon - detailed walkthrough of the entire process</p>
                            </div>
                        </div>
                    </div>

                    <div class="help-section">
                        <h2>Contact Support</h2>
                        <div class="help-content">
                            <form class="support-form">
                                <div class="form-group">
                                    <label for="support-name">Name</label>
                                    <input type="text" id="support-name" required>
                                </div>
                                <div class="form-group">
                                    <label for="support-email">Email</label>
                                    <input type="email" id="support-email" required>
                                </div>
                                <div class="form-group">
                                    <label for="support-message">Message</label>
                                    <textarea id="support-message" rows="4" required></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">Send Message</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- About Page -->
            <div id="about-page" class="page">
                <nav class="breadcrumb">
                    <a href="#/" onclick="navigateToPage('landing')">Home</a> > About
                </nav>
                <div class="page-header">
                    <h1>About VAT Calculator Pro</h1>
                    <p>Professional VAT processing for the modern business</p>
                </div>

                <div class="about-sections">
                    <div class="about-section">
                        <h2>Product Overview</h2>
                        <div class="about-content">
                            <p>VAT Calculator Pro is a cutting-edge web application designed to revolutionize how South African businesses handle VAT calculations. Built with modern web technologies, it transforms traditional Excel-based VAT processing into a streamlined, automated experience.</p>
                            
                            <div class="benefits-grid">
                                <div class="benefit-item">
                                    <h3>🚀 Efficiency</h3>
                                    <p>Reduce VAT calculation time from hours to minutes with automated processing and intelligent categorization.</p>
                                </div>
                                <div class="benefit-item">
                                    <h3>🎯 Accuracy</h3>
                                    <p>Eliminate human errors with precise calculations and SARS-compliant categorization algorithms.</p>
                                </div>
                                <div class="benefit-item">
                                    <h3>💼 Professional</h3>
                                    <p>Generate stunning, professional reports that impress clients and meet regulatory requirements.</p>
                                </div>
                                <div class="benefit-item">
                                    <h3>🔒 Secure</h3>
                                    <p>Keep your data safe with client-side processing - no uploads, no servers, complete privacy.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="about-section">
                        <h2>Privacy & Security</h2>
                        <div class="about-content">
                            <div class="privacy-highlights">
                                <div class="privacy-item">
                                    <h3>🔐 Client-Side Processing</h3>
                                    <p>All calculations happen entirely in your browser. Your sensitive financial data never leaves your device.</p>
                                </div>
                                <div class="privacy-item">
                                    <h3>🚫 No Data Storage</h3>
                                    <p>We don't store, log, or transmit any of your data. Once you close the browser, everything is gone.</p>
                                </div>
                                <div class="privacy-item">
                                    <h3>✅ POPIA Compliant</h3>
                                    <p>Fully compliant with South Africa's Protection of Personal Information Act and international privacy standards.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="about-section">
                        <h2>Terms of Service</h2>
                        <div class="about-content">
                            <div class="terms-content">
                                <h3>Usage License</h3>
                                <p>VAT Calculator Pro is provided as-is for professional VAT calculation purposes. Users are responsible for verifying results and ensuring compliance with current SARS regulations.</p>
                                
                                <h3>Accuracy Disclaimer</h3>
                                <p>While we strive for 100% accuracy, users should review all calculations and consult with qualified tax professionals for complex scenarios.</p>
                                
                                <h3>Support</h3>
                                <p>Support is provided on a best-effort basis. For urgent issues, please contact our support team using the form on the Help page.</p>
                            </div>
                        </div>
                    </div>

                    <div class="about-section">
                        <h2>Contact Information</h2>
                        <div class="about-content">
                            <div class="contact-grid">
                                <div class="contact-item">
                                    <h3>📧 Email Support</h3>
                                    <p>support@vatcalculatorpro.com</p>
                                    <p>Response within 24 hours</p>
                                </div>
                                <div class="contact-item">
                                    <h3>💬 Live Chat</h3>
                                    <p>Available Monday-Friday</p>
                                    <p>9:00 AM - 5:00 PM SAST</p>
                                </div>
                                <div class="contact-item">
                                    <h3>📱 WhatsApp</h3>
                                    <p>+27 XX XXX XXXX</p>
                                    <p>Business hours only</p>
                                </div>
                                <div class="contact-item">
                                    <h3>🌐 Website</h3>
                                    <p>www.vatcalculatorpro.com</p>
                                    <p>Latest updates and news</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="about-section">
                        <h2>Data Security</h2>
                        <div class="about-content">
                            <div class="security-features">
                                <h3>🛡️ Security Measures</h3>
                                <ul>
                                    <li>HTTPS encryption for all data transmission</li>
                                    <li>Client-side processing prevents data exposure</li>
                                    <li>No cookies or tracking beyond essential analytics</li>
                                    <li>Regular security audits and updates</li>
                                    <li>Secure hosting infrastructure</li>
                                </ul>
                                
                                <h3>🔍 Data Handling</h3>
                                <p>We handle your data with the utmost care:</p>
                                <ul>
                                    <li>Files are processed locally in your browser memory</li>
                                    <li>No temporary files created on external servers</li>
                                    <li>Calculation results exist only while the page is open</li>
                                    <li>Browser cache cleared automatically</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Page -->
            <div id="settings-page" class="page">
                <nav class="breadcrumb">
                    <a href="#/" onclick="navigateToPage('landing')">Home</a> > Settings
                </nav>
                <div class="page-header">
                    <h1>Settings & Customization</h1>
                    <p>Customize your VAT Calculator experience</p>
                </div>

                <div class="settings-sections">
                    <!-- Company Information -->
                    <div class="settings-section">
                        <h2>Company Information</h2>
                        <div class="settings-content">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="company-name">Company Name</label>
                                    <input type="text" id="company-name" placeholder="Your Company Name">
                                </div>
                                <div class="form-group">
                                    <label for="vat-number">VAT Number</label>
                                    <input type="text" id="vat-number" placeholder="VAT Registration Number">
                                </div>
                                <div class="form-group">
                                    <label for="company-address">Address</label>
                                    <textarea id="company-address" rows="3" placeholder="Company Address"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="contact-email">Contact Email</label>
                                    <input type="email" id="contact-email" placeholder="contact@company.com">
                                </div>
                                <div class="form-group">
                                    <label for="company-logo">Company Logo</label>
                                    <div class="file-upload-area">
                                        <input type="file" id="company-logo" accept="image/*">
                                        <div class="upload-placeholder">
                                            <div class="upload-icon">🏢</div>
                                            <p>Upload logo (PNG, JPG)</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TrCode Mapping -->
                    <div class="settings-section">
                        <h2>Transaction Code Mapping</h2>
                        <div class="settings-content">
                            <div class="mapping-grid">
                                <div class="mapping-section">
                                    <h3>INPUT VAT Codes (Purchases)</h3>
                                    <div class="code-list">
                                        <div class="code-items" id="input-codes">
                                            <!-- Will be populated by JavaScript -->
                                        </div>
                                        <div class="add-code">
                                            <input type="text" id="new-input-code" placeholder="Add new INPUT code" maxlength="10">
                                            <button class="btn btn-small" onclick="addInputCode()">Add</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="mapping-section">
                                    <h3>OUTPUT VAT Codes (Sales)</h3>
                                    <div class="code-list">
                                        <div class="code-items" id="output-codes">
                                            <!-- Will be populated by JavaScript -->
                                        </div>
                                        <div class="add-code">
                                            <input type="text" id="new-output-code" placeholder="Add new OUTPUT code" maxlength="10">
                                            <button class="btn btn-small" onclick="addOutputCode()">Add</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mapping-actions">
                                <select id="industry-presets" onchange="loadIndustryPreset()">
                                    <option value="">Select Industry Preset</option>
                                    <option value="retail">Retail Business</option>
                                    <option value="services">Professional Services</option>
                                    <option value="manufacturing">Manufacturing</option>
                                    <option value="hospitality">Hospitality</option>
                                </select>
                                <button class="btn btn-secondary" onclick="resetToDefaults()">Reset to Defaults</button>
                            </div>
                        </div>
                    </div>

                    <!-- Report Preferences -->
                    <div class="settings-section">
                        <h2>Report Preferences</h2>
                        <div class="settings-content">
                            <div class="preferences-grid">
                                <div class="preference-group">
                                    <label for="default-export">Default Export Format</label>
                                    <select id="default-export">
                                        <option value="pdf">PDF Report</option>
                                        <option value="excel">Excel Spreadsheet</option>
                                        <option value="print">Print View</option>
                                    </select>
                                </div>
                                <div class="preference-group">
                                    <label for="color-theme">Color Theme</label>
                                    <select id="color-theme" onchange="changeTheme()">
                                        <option value="default">Professional Blue</option>
                                        <option value="green">Corporate Green</option>
                                        <option value="purple">Modern Purple</option>
                                    </select>
                                </div>
                                <div class="preference-group">
                                    <label for="date-format">Date Format</label>
                                    <select id="date-format">
                                        <option value="dd/mm/yyyy">DD/MM/YYYY</option>
                                        <option value="mm/dd/yyyy">MM/DD/YYYY</option>
                                        <option value="yyyy-mm-dd">YYYY-MM-DD</option>
                                    </select>
                                </div>
                                <div class="preference-group">
                                    <label for="currency-display">Currency Display</label>
                                    <select id="currency-display">
                                        <option value="ZAR">South African Rand (R)</option>
                                        <option value="USD">US Dollar ($)</option>
                                        <option value="EUR">Euro (€)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Data Storage -->
                    <div class="settings-section">
                        <h2>Data Storage Settings</h2>
                        <div class="settings-content">
                            <div class="storage-options">
                                <div class="storage-group">
                                    <label for="history-retention">History Retention Period</label>
                                    <select id="history-retention">
                                        <option value="30">30 days</option>
                                        <option value="60">60 days</option>
                                        <option value="90" selected>90 days</option>
                                        <option value="180">6 months</option>
                                        <option value="365">1 year</option>
                                    </select>
                                </div>
                                <div class="storage-group">
                                    <div class="checkbox-group">
                                        <input type="checkbox" id="auto-save" checked>
                                        <label for="auto-save">Auto-save calculations to history</label>
                                    </div>
                                </div>
                                <div class="storage-group">
                                    <div class="checkbox-group">
                                        <input type="checkbox" id="save-settings">
                                        <label for="save-settings">Remember my settings</label>
                                    </div>
                                </div>
                            </div>
                            <div class="danger-zone">
                                <h3>Danger Zone</h3>
                                <p>These actions cannot be undone.</p>
                                <div class="danger-actions">
                                    <button class="btn btn-danger" onclick="clearAllHistory()">Clear All History</button>
                                    <button class="btn btn-danger" onclick="resetAllSettings()">Reset All Settings</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-actions">
                    <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
                    <button class="btn btn-secondary" onclick="loadSettings()">Load Defaults</button>
                </div>
            </div>

            <!-- History Page -->
            <div id="history-page" class="page">
                <nav class="breadcrumb">
                    <a href="#/" onclick="navigateToPage('landing')">Home</a> > History
                </nav>
                <div class="page-header">
                    <h1>Calculation History</h1>
                    <p>Review and manage your previous VAT calculations</p>
                </div>

                <div class="history-sections">
                    <!-- Quick Stats -->
                    <div class="history-stats">
                        <div class="stat-card">
                            <div class="stat-icon">📊</div>
                            <div class="stat-content">
                                <div class="stat-number" id="total-calculations">0</div>
                                <div class="stat-label">Total Calculations</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">💰</div>
                            <div class="stat-content">
                                <div class="stat-number" id="total-vat-processed">R 0</div>
                                <div class="stat-label">Total VAT Processed</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">📅</div>
                            <div class="stat-content">
                                <div class="stat-number" id="last-calculation">Never</div>
                                <div class="stat-label">Last Calculation</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">📈</div>
                            <div class="stat-content">
                                <div class="stat-number" id="avg-vat-payable">R 0</div>
                                <div class="stat-label">Avg VAT Payable</div>
                            </div>
                        </div>
                    </div>

                    <!-- Period Comparison -->
                    <div class="comparison-section">
                        <h2>Period Comparison</h2>
                        <div class="comparison-controls">
                            <select id="period1-select">
                                <option value="">Select Period 1</option>
                            </select>
                            <span class="vs-text">vs</span>
                            <select id="period2-select">
                                <option value="">Select Period 2</option>
                            </select>
                            <button class="btn btn-primary" onclick="comparePeroids()">Compare</button>
                        </div>
                        <div id="comparison-results" class="comparison-results" style="display: none;">
                            <!-- Comparison results will be populated here -->
                        </div>
                    </div>

                    <!-- History List -->
                    <div class="history-list-section">
                        <div class="history-header">
                            <h2>Calculation History</h2>
                            <div class="history-actions">
                                <button class="btn btn-secondary" onclick="exportHistoryCSV()">Export CSV</button>
                                <button class="btn btn-danger" onclick="clearSelectedHistory()">Clear Selected</button>
                            </div>
                        </div>
                        <div class="history-filters">
                            <input type="text" id="history-search" placeholder="Search calculations..." onkeyup="filterHistory()">
                            <select id="history-sort" onchange="sortHistory()">
                                <option value="date-desc">Newest First</option>
                                <option value="date-asc">Oldest First</option>
                                <option value="amount-desc">Highest VAT</option>
                                <option value="amount-asc">Lowest VAT</option>
                            </select>
                        </div>
                        <div class="history-list" id="history-list">
                            <!-- History items will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upload Page -->
            <div id="upload-page" class="page">
                <div class="card">
                    <h2>Upload Your VAT Excel File</h2>
                    <p>Upload your Excel file containing VAT transaction data. We support .xlsx and .xls files up to 50MB.</p>
                    
                    <div class="upload-zone" onclick="document.getElementById('file-input').click()">
                        <div class="upload-icon">📄</div>
                        <h3>Click to upload or drag and drop</h3>
                        <p>Support for .xlsx and .xls files (up to 50MB)</p>
                        <input type="file" id="file-input" class="file-input" accept=".xlsx,.xls" onchange="handleFileSelect(event)">
                    </div>

                    <div id="file-status" class="file-status"></div>

                    <div class="file-requirements">
                        <h3>Required Excel Columns</h3>
                        <ul>
                            <li><strong>TaxCode</strong> - Tax classification (1, 3, or 5)</li>
                            <li><strong>TaxDescription</strong> - Description of tax type</li>
                            <li><strong>TrCode</strong> - Transaction code (CASH, INV, IS, etc.)</li>
                            <li><strong>TaxRate</strong> - Tax percentage rate</li>
                            <li><strong>TaxAmount</strong> - VAT amount</li>
                            <li><strong>ExclAmount</strong> - Amount excluding VAT</li>
                            <li><strong>InclAmount</strong> - Amount including VAT</li>
                        </ul>
                    </div>

                    <button id="process-btn" class="btn btn-primary btn-block" onclick="processFile()" disabled>
                        Continue to Processing
                    </button>
                </div>
            </div>

            <!-- Processing Page -->
            <div id="processing-page" class="page">
                <div class="processing-container">
                    <h2>Processing Your VAT Data</h2>
                    <p>Please don't close this window while we process your file.</p>

                    <div class="loading-spinner"></div>
                    
                    <div class="progress-bar">
                        <div id="progress-fill" class="progress-fill"></div>
                    </div>

                    <div class="progress-steps">
                        <div class="progress-step" id="step-1">
                            <div class="step-number">1</div>
                            <div>
                                <div class="step-title">Reading Excel File</div>
                                <div class="step-description">Parsing and validating file format</div>
                            </div>
                        </div>
                        <div class="progress-step" id="step-2">
                            <div class="step-number">2</div>
                            <div>
                                <div class="step-title">Validating Data</div>
                                <div class="step-description">Checking required columns and data types</div>
                            </div>
                        </div>
                        <div class="progress-step" id="step-3">
                            <div class="step-number">3</div>
                            <div>
                                <div class="step-title">Calculating VAT</div>
                                <div class="step-description">Processing transactions and computing totals</div>
                            </div>
                        </div>
                        <div class="progress-step" id="step-4">
                            <div class="step-number">4</div>
                            <div>
                                <div class="step-title">Generating Report</div>
                                <div class="step-description">Creating professional calculation summary</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Page -->
            <div id="results-page" class="page">
                <h2>VAT Calculation Results</h2>
                
                <!-- Export Toolbar -->
                <div class="export-toolbar">
                    <div class="export-buttons">
                        <button class="btn btn-export pdf" onclick="exportToPDF()" title="Export to PDF">
                            📄 PDF
                        </button>
                        <button class="btn btn-export excel" onclick="exportToExcel()" title="Export to Excel">
                            📊 Excel
                        </button>
                        <button class="btn btn-export email" onclick="shareViaEmail()" title="Share via Email">
                            📧 Email
                        </button>
                        <button class="btn btn-export print" onclick="printReport()" title="Print Report">
                            🖨️ Print
                        </button>
                    </div>
                    <div class="export-actions">
                        <button class="btn btn-secondary share" onclick="shareToLinkedIn()" title="Share on LinkedIn">
                            💼 Share
                        </button>
                        <button class="btn btn-secondary save" onclick="saveToHistory()" title="Save to History">
                            💾 Save
                        </button>
                    </div>
                </div>
                
                <div class="results-summary">
                    <div class="summary-card output-vat">
                        <div class="summary-label">Total Output VAT</div>
                        <div class="summary-amount" id="total-output-vat">R 0.00</div>
                    </div>
                    <div class="summary-card input-vat">
                        <div class="summary-label">Total Input VAT</div>
                        <div class="summary-amount" id="total-input-vat">R 0.00</div>
                    </div>
                    <div class="summary-card sales-incl">
                        <div class="summary-label">Sales Including VAT</div>
                        <div class="summary-amount" id="sales-including-vat">R 0.00</div>
                    </div>
                    <div class="summary-card sales-excl">
                        <div class="summary-label">Sales Excluding VAT</div>
                        <div class="summary-amount" id="sales-excluding-vat">R 0.00</div>
                    </div>
                    <div class="summary-card zero-rated">
                        <div class="summary-label">Zero Rated Sales</div>
                        <div class="summary-amount" id="zero-rated-sales">R 0.00</div>
                    </div>
                </div>

                <div class="vat-payable">
                    <h2 id="vat-payable-label">VAT Payable</h2>
                    <div class="amount" id="vat-payable-amount">R 0.00</div>
                </div>

                <div id="breakdown-sections">
                    <!-- Breakdown sections will be populated by JavaScript -->
                </div>

                <div class="text-center mt-3">
                    <button class="btn btn-primary" onclick="navigateToPage('upload')">
                        📊 Process Another File
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <div class="footer-logo">
                        <div class="logo-icon">V</div>
                        VAT Calculator Pro
                    </div>
                    <p>Professional VAT processing for modern businesses</p>
                </div>
                <div class="footer-section">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="#/" onclick="navigateToPage('landing')">Home</a></li>
                        <li><a href="#/demo" onclick="navigateToPage('demo')">Demo</a></li>
                        <li><a href="#/help" onclick="navigateToPage('help')">Help</a></li>
                        <li><a href="#/about" onclick="navigateToPage('about')">About</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Support</h4>
                    <ul>
                        <li><a href="#/help" onclick="navigateToPage('help')">Documentation</a></li>
                        <li><a href="#/help" onclick="navigateToPage('help')">Contact Support</a></li>
                        <li><a href="#/about" onclick="navigateToPage('about')">Privacy Policy</a></li>
                        <li><a href="#/about" onclick="navigateToPage('about')">Terms of Service</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Security</h4>
                    <ul>
                        <li>🔒 Client-side Processing</li>
                        <li>🛡️ No Data Storage</li>
                        <li>✅ POPIA Compliant</li>
                        <li>🔐 HTTPS Secure</li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 VAT Calculator Pro. All rights reserved. | Made with ❤️ for South African businesses</p>
            </div>
        </div>
    </footer>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Load XLSX library asynchronously to prevent blocking
        function loadXLSXLibrary() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
                script.onload = () => {
                    console.log('XLSX library loaded successfully');
                    resolve();
                };
                script.onerror = () => {
                    console.warn('XLSX library failed to load - file processing will be limited');
                    resolve(); // Don't reject, just continue without XLSX
                };
                document.head.appendChild(script);
            });
        }
    </script>

    <script>
        // Add error handling for debugging
        window.addEventListener('error', function(e) {
            console.error('JavaScript Error:', e.error);
            console.error('Error message:', e.message);
            console.error('File:', e.filename);
            console.error('Line:', e.lineno);
        });

        // Global Variables
        console.log('VAT Calculator Pro - Script loading started');
        let currentFile = null;
        let processedData = null;

        // VAT Business Logic Constants
        const VAT_INPUT_CODES = ['CASH', 'JC', 'JNL', 'SINV', 'JD', 'RC'];
        const VAT_OUTPUT_CODES = ['IS', 'INV', 'RTS'];
        const TAX_CODES = {
            '1': { description: 'Standard Rate (15%)', rate: 15 },
            '3': { description: 'Zero Rate (0%)', rate: 0 },
            '5': { description: 'Exempt (0%)', rate: 0 }
        };

        // Navigation Functions
        function navigateToPage(pageName) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });

            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });

            // Show target page
            const targetPage = document.getElementById(`${pageName}-page`);
            if (targetPage) {
                targetPage.classList.add('active');
                
                // Update URL hash
                window.location.hash = `/${pageName}`;
                
                // Update active nav link
                const navLink = document.querySelector(`[data-page="${pageName}"]`);
                if (navLink) {
                    navLink.classList.add('active');
                }
            }
        }

        // Handle browser back/forward navigation
        window.addEventListener('hashchange', function() {
            const hash = window.location.hash;
            if (hash === '#/upload') {
                navigateToPage('upload');
            } else if (hash === '#/processing') {
                navigateToPage('processing');
            } else if (hash === '#/results') {
                navigateToPage('results');
            } else if (hash === '#/demo') {
                navigateToPage('demo');
            } else if (hash === '#/help') {
                navigateToPage('help');
            } else if (hash === '#/about') {
                navigateToPage('about');
            } else if (hash === '#/settings') {
                navigateToPage('settings');
            } else if (hash === '#/history') {
                navigateToPage('history');
            } else {
                navigateToPage('landing');
            }
        });

        // Mobile menu toggle
        function toggleMobileMenu() {
            const navLinks = document.querySelector('.nav-links');
            navLinks.classList.toggle('show');
        }

        // Download sample template function
        function downloadSampleTemplate() {
            // Create sample data
            const sampleData = [
                {
                    TaxCode: 1,
                    TaxDescription: "Standard Rate (Excluding Capital Goods)",
                    TrCode: "INV",
                    TaxRate: 15,
                    TaxAmount: 150.00,
                    ExclAmount: 1000.00,
                    InclAmount: 1150.00
                },
                {
                    TaxCode: 1,
                    TaxDescription: "Standard Rate (Excluding Capital Goods)",
                    TrCode: "CASH",
                    TaxRate: 15,
                    TaxAmount: 75.00,
                    ExclAmount: 500.00,
                    InclAmount: 575.00
                },
                {
                    TaxCode: 3,
                    TaxDescription: "Zero Rate",
                    TrCode: "IS",
                    TaxRate: 0,
                    TaxAmount: 0.00,
                    ExclAmount: 2000.00,
                    InclAmount: 2000.00
                }
            ];

            // Convert to worksheet
            const ws = XLSX.utils.json_to_sheet(sampleData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "VAT Data");

            // Download file
            XLSX.writeFile(wb, "VAT_Calculator_Sample_Template.xlsx");
        }

        // Support form submission
        document.addEventListener('DOMContentLoaded', function() {
            const supportForm = document.querySelector('.support-form');
            if (supportForm) {
                supportForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const name = document.getElementById('support-name').value;
                    const email = document.getElementById('support-email').value;
                    const message = document.getElementById('support-message').value;
                    
                    // Simulate form submission
                    alert(`Thank you ${name}! Your message has been received. We'll respond to ${email} within 24 hours.`);
                    
                    // Reset form
                    supportForm.reset();
                });
            }
        });

        // Enhanced navigation with smooth transitions
        function navigateToPage(pageName) {
            // Add loading state
            document.body.classList.add('loading');
            
            setTimeout(() => {
                // Hide all pages
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                });

                // Update navigation
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                });

                // Show target page
                const targetPage = document.getElementById(`${pageName}-page`);
                if (targetPage) {
                    targetPage.classList.add('active');
                    
                    // Update URL hash
                    window.location.hash = `/${pageName}`;
                    
                    // Update active nav link
                    const navLink = document.querySelector(`[data-page="${pageName}"]`);
                    if (navLink) {
                        navLink.classList.add('active');
                    }

                    // Scroll to top
                    window.scrollTo(0, 0);
                }

                // Remove loading state
                document.body.classList.remove('loading');
                
                // Close mobile menu if open
                const navLinks = document.querySelector('.nav-links');
                if (navLinks) {
                    navLinks.classList.remove('show');
                }
            }, 150);
        }

        // File Upload Functions
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                validateFile(file);
            }
        }

        function validateFile(file) {
            const statusDiv = document.getElementById('file-status');
            const processBtn = document.getElementById('process-btn');

            // Reset status
            statusDiv.className = 'file-status';
            statusDiv.style.display = 'none';

            // Check file type
            const validTypes = ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 
                              'application/vnd.ms-excel'];
            if (!validTypes.includes(file.type) && 
                !file.name.toLowerCase().endsWith('.xlsx') && 
                !file.name.toLowerCase().endsWith('.xls')) {
                showFileStatus('error', 'Invalid file type. Please upload a .xlsx or .xls file.');
                processBtn.disabled = true;
                return;
            }

            // Check file size (50MB limit)
            if (file.size > 50 * 1024 * 1024) {
                showFileStatus('error', 'File is too large. Maximum size is 50MB.');
                processBtn.disabled = true;
                return;
            }

            // File is valid
            currentFile = file;
            showFileStatus('success', `File "${file.name}" is ready for processing (${formatFileSize(file.size)})`);
            processBtn.disabled = false;
        }

        function showFileStatus(type, message) {
            const statusDiv = document.getElementById('file-status');
            statusDiv.className = `file-status ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Drag and Drop Functionality
        document.addEventListener('DOMContentLoaded', function() {
            const uploadZone = document.querySelector('.upload-zone');
            
            if (uploadZone) {
                uploadZone.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    uploadZone.classList.add('dragover');
                });

                uploadZone.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    uploadZone.classList.remove('dragover');
                });

                uploadZone.addEventListener('drop', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    uploadZone.classList.remove('dragover');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const file = files[0];
                        document.getElementById('file-input').files = files;
                        validateFile(file);
                    }
                });
            }
        });

        // File Processing Functions
        async function processFile() {
            if (!currentFile) {
                alert('Please select a file first.');
                return;
            }

            // Navigate to processing page
            navigateToPage('processing');

            try {
                // Step 1: Read Excel file
                await updateProgress(1, 'Reading Excel file...');
                const workbook = await readExcelFile(currentFile);

                // Step 2: Validate data
                await updateProgress(2, 'Validating data structure...');
                const data = validateExcelData(workbook);

                // Step 3: Calculate VAT
                await updateProgress(3, 'Calculating VAT totals...');
                const results = calculateVAT(data);

                // Step 4: Generate report
                await updateProgress(4, 'Generating professional report...');
                processedData = results;
                
                await new Promise(resolve => setTimeout(resolve, 500)); // Final pause for effect

                // Navigate to results
                displayResults(results);
                navigateToPage('results');

            } catch (error) {
                console.error('Processing error:', error);
                alert('Error processing file: ' + error.message);
                navigateToPage('upload');
            }
        }

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = e.target.result;
                        const workbook = XLSX.read(data, { type: 'binary' });
                        resolve(workbook);
                    } catch (error) {
                        reject(new Error('Failed to read Excel file. Please ensure it\'s a valid Excel file.'));
                    }
                };
                reader.onerror = function() {
                    reject(new Error('Failed to read file.'));
                };
                reader.readAsBinaryString(file);
            });
        }

        function validateExcelData(workbook) {
            // Get the first worksheet
            const sheetName = workbook.SheetNames[0];
            if (!sheetName) {
                throw new Error('No worksheets found in the Excel file.');
            }

            const worksheet = workbook.Sheets[sheetName];
            const data = XLSX.utils.sheet_to_json(worksheet);

            if (data.length === 0) {
                throw new Error('The Excel file appears to be empty.');
            }

            // Check required columns
            const requiredColumns = ['TaxCode', 'TaxDescription', 'TrCode', 'TaxRate', 'TaxAmount', 'ExclAmount', 'InclAmount'];
            const firstRow = data[0];
            const missingColumns = requiredColumns.filter(col => !(col in firstRow));

            if (missingColumns.length > 0) {
                throw new Error(`Missing required columns: ${missingColumns.join(', ')}`);
            }

            // Validate data types and values
            const validatedData = data.map((row, index) => {
                const rowNum = index + 2; // Excel row number (accounting for header)

                // Validate TaxCode
                if (!TAX_CODES[String(row.TaxCode)]) {
                    console.warn(`Row ${rowNum}: Invalid TaxCode "${row.TaxCode}", skipping`);
                    return null;
                }

                // Validate numeric fields
                const numericFields = ['TaxRate', 'TaxAmount', 'ExclAmount', 'InclAmount'];
                for (const field of numericFields) {
                    if (isNaN(Number(row[field]))) {
                        console.warn(`Row ${rowNum}: Invalid ${field} "${row[field]}", skipping`);
                        return null;
                    }
                }

                // Convert to proper types and preserve additional columns
                const processedRow = {
                    TaxCode: String(row.TaxCode),
                    TaxDescription: String(row.TaxDescription || ''),
                    TrCode: String(row.TrCode || '').toUpperCase(),
                    TaxRate: Number(row.TaxRate) || 0,
                    TaxAmount: Number(row.TaxAmount) || 0,
                    ExclAmount: Number(row.ExclAmount) || 0,
                    InclAmount: Number(row.InclAmount) || 0,
                    
                    // Preserve additional columns for export - debugging
                    TxDate: row.TxDate || row.txDate || row.TransactionDate || row.Date || '',
                    Reference: row.Reference || row.reference || row.Ref || row.RefNo || '',
                    TmDescription: row.TmDescription || row.tmDescription || row.Description || '',
                    TaxType: row.TaxType || row.taxType || '',
                    Reference2: row.Reference2 || row.reference2 || '',
                    Order_No: row.Order_No || row.OrderNo || row.order_no || '',
                    cAuditNumber: row.cAuditNumber || row.AuditNumber || row.auditNumber || '',
                    DTStamp: row.DTStamp || row.dtStamp || row.DateStamp || row.Timestamp || ''
                };

                // Debug first few rows to see date format
                if (index < 3) {
                    console.log(`Row ${index + 1} TxDate:`, {
                        original: row.TxDate,
                        processed: processedRow.TxDate,
                        type: typeof processedRow.TxDate
                    });
                }

                return processedRow;
            }).filter(row => row !== null);

            if (validatedData.length === 0) {
                throw new Error('No valid data rows found in the Excel file.');
            }

            console.log(`Validated ${validatedData.length} rows of data`);
            return validatedData;
        }

        function calculateVAT(data) {
            const results = {
                totalInputVAT: 0,
                totalOutputVAT: 0,
                salesExcludingVAT: 0,
                salesIncludingVAT: 0,
                zeroRatedSales: 0,
                taxCodeBreakdown: {}
            };

            // Initialize tax code breakdowns
            for (const [code, info] of Object.entries(TAX_CODES)) {
                results.taxCodeBreakdown[code] = {
                    description: info.description,
                    rate: info.rate,
                    input: {
                        count: 0,
                        vatAmount: 0,
                        exclAmount: 0,
                        transactions: []
                    },
                    output: {
                        count: 0,
                        vatAmount: 0,
                        exclAmount: 0,
                        transactions: []
                    }
                };
            }

            // Process each transaction
            data.forEach(row => {
                const taxCode = row.TaxCode;
                const trCode = row.TrCode;
                const taxAmount = row.TaxAmount;
                const exclAmount = row.ExclAmount;

                // Determine if this is INPUT or OUTPUT
                const isInput = VAT_INPUT_CODES.includes(trCode);
                const isOutput = VAT_OUTPUT_CODES.includes(trCode);

                if (!isInput && !isOutput) {
                    console.warn(`Unknown TrCode: ${trCode}, skipping transaction`);
                    return;
                }

                // Add to appropriate category
                const category = isInput ? 'input' : 'output';
                const breakdown = results.taxCodeBreakdown[taxCode][category];

                breakdown.count++;
                breakdown.vatAmount += taxAmount;
                breakdown.exclAmount += exclAmount;

                // Store all transactions for detailed reporting
                breakdown.transactions.push({
                    TrCode: trCode,
                    TaxAmount: taxAmount,
                    ExclAmount: exclAmount,
                    InclAmount: row.InclAmount,
                    TaxDescription: row.TaxDescription,
                    TxDate: row.TxDate,
                    Reference: row.Reference
                });

                // Add to totals
                if (isInput) {
                    results.totalInputVAT += taxAmount;
                } else {
                    results.totalOutputVAT += taxAmount;
                    results.salesExcludingVAT += exclAmount;
                    
                    // Zero-rated sales (Tax Code 3)
                    if (taxCode === '3') {
                        results.zeroRatedSales += exclAmount;
                    }
                }
            });

            // Calculate final values
            results.salesIncludingVAT = results.salesExcludingVAT + results.totalOutputVAT;
            results.vatPayable = results.totalOutputVAT - results.totalInputVAT;

            console.log('VAT Calculation Results:', results);
            return results;
        }

        async function updateProgress(step, message) {
            // Update progress bar
            const progressFill = document.getElementById('progress-fill');
            const progressPercentage = (step / 4) * 100;
            progressFill.style.width = `${progressPercentage}%`;

            // Update step status
            for (let i = 1; i <= 4; i++) {
                const stepElement = document.getElementById(`step-${i}`);
                if (i < step) {
                    stepElement.className = 'progress-step completed';
                } else if (i === step) {
                    stepElement.className = 'progress-step active';
                } else {
                    stepElement.className = 'progress-step';
                }
            }

            // Add a small delay to make the progress visible
            await new Promise(resolve => setTimeout(resolve, 800));
        }

        // Results Display Functions
        function displayResults(results) {
            // Update summary cards
            document.getElementById('total-output-vat').textContent = formatCurrency(results.totalOutputVAT);
            document.getElementById('total-input-vat').textContent = formatCurrency(results.totalInputVAT);
            document.getElementById('sales-including-vat').textContent = formatCurrency(results.salesIncludingVAT);
            document.getElementById('sales-excluding-vat').textContent = formatCurrency(results.salesExcludingVAT);
            document.getElementById('zero-rated-sales').textContent = formatCurrency(results.zeroRatedSales);

            // Update VAT payable/refund
            const vatPayableAmount = document.getElementById('vat-payable-amount');
            const vatPayableLabel = document.getElementById('vat-payable-label');
            
            if (results.vatPayable >= 0) {
                vatPayableLabel.textContent = 'VAT Payable';
                vatPayableAmount.textContent = formatCurrency(results.vatPayable);
            } else {
                vatPayableLabel.textContent = 'VAT Refund';
                vatPayableAmount.textContent = formatCurrency(Math.abs(results.vatPayable));
            }

            // Generate breakdown sections
            generateBreakdownSections(results.taxCodeBreakdown);
        }

        function generateBreakdownSections(taxCodeBreakdown) {
            const container = document.getElementById('breakdown-sections');
            container.innerHTML = '';

            for (const [taxCode, breakdown] of Object.entries(taxCodeBreakdown)) {
                // Skip if no transactions for this tax code
                if (breakdown.input.count === 0 && breakdown.output.count === 0) {
                    continue;
                }

                const section = document.createElement('div');
                section.className = 'breakdown-section';

                section.innerHTML = `
                    <div class="breakdown-header">
                        <h3>Tax Code ${taxCode}: ${breakdown.description} (${breakdown.rate}%)</h3>
                    </div>
                    <div class="breakdown-content">
                        <div class="input-output-grid">
                            <div class="input-section">
                                <div class="section-title">
                                    📥 INPUT VAT (Purchases)
                                </div>
                                <div class="stat-grid">
                                    <div class="stat-row">
                                        <span class="stat-label">Transactions</span>
                                        <span class="stat-value">${breakdown.input.count.toLocaleString()}</span>
                                    </div>
                                    <div class="stat-row">
                                        <span class="stat-label">VAT Amount</span>
                                        <span class="stat-value">${formatCurrency(breakdown.input.vatAmount)}</span>
                                    </div>
                                    <div class="stat-row">
                                        <span class="stat-label">Excl Amount</span>
                                        <span class="stat-value">${formatCurrency(breakdown.input.exclAmount)}</span>
                                    </div>
                                </div>
                                ${generateSampleTransactions(breakdown.input.transactions, 'Input')}
                            </div>
                            <div class="output-section">
                                <div class="section-title">
                                    📤 OUTPUT VAT (Sales)
                                </div>
                                <div class="stat-grid">
                                    <div class="stat-row">
                                        <span class="stat-label">Transactions</span>
                                        <span class="stat-value">${breakdown.output.count.toLocaleString()}</span>
                                    </div>
                                    <div class="stat-row">
                                        <span class="stat-label">VAT Amount</span>
                                        <span class="stat-value">${formatCurrency(breakdown.output.vatAmount)}</span>
                                    </div>
                                    <div class="stat-row">
                                        <span class="stat-label">Excl Amount</span>
                                        <span class="stat-value">${formatCurrency(breakdown.output.exclAmount)}</span>
                                    </div>
                                </div>
                                ${generateSampleTransactions(breakdown.output.transactions, 'Output')}
                            </div>
                        </div>
                    </div>
                `;

                container.appendChild(section);
            }
        }

        function generateSampleTransactions(transactions, type) {
            if (transactions.length === 0) {
                return '<div class="sample-transactions"><p>No transactions</p></div>';
            }

            const tableRows = transactions.map(tx => `
                <tr>
                    <td>${tx.TrCode}</td>
                    <td>${formatCurrency(tx.ExclAmount)}</td>
                    <td>${formatCurrency(tx.TaxAmount)}</td>
                </tr>
            `).join('');

            return `
                <div class="sample-transactions">
                    <h4>Sample ${type} Transactions</h4>
                    <table class="transaction-table">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Excl Amount</th>
                                <th>VAT Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function formatCurrency(amount) {
            return 'R ' + Number(amount).toLocaleString('en-ZA', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('DOM Content Loaded - Initializing VAT Calculator Pro');
            
            // Load external libraries
            try {
                await loadXLSXLibrary();
            } catch (error) {
                console.warn('Failed to load external libraries:', error);
            }

            // Handle initial page load
            const hash = window.location.hash;
            console.log('Current hash:', hash);
            
            if (hash === '#/upload') {
                navigateToPage('upload');
            } else if (hash === '#/processing') {
                navigateToPage('processing');
            } else if (hash === '#/results') {
                navigateToPage('results');
            } else if (hash === '#/demo') {
                navigateToPage('demo');
            } else if (hash === '#/help') {
                navigateToPage('help');
            } else if (hash === '#/about') {
                navigateToPage('about');
            } else if (hash === '#/settings') {
                navigateToPage('settings');
            } else if (hash === '#/history') {
                navigateToPage('history');
            } else {
                navigateToPage('landing');
            }

            // Store navigation preference
            if (typeof(Storage) !== "undefined") {
                localStorage.setItem('vatCalculatorVisited', 'true');
            }

            console.log('VAT Calculator Pro initialized - Enhanced Multi-Page Version');
        });

        // Advanced Features JavaScript

        // Settings Manager
        class SettingsManager {
            constructor() {
                this.settings = this.loadSettings();
                this.initializeSettings();
            }

            loadSettings() {
                const defaultSettings = {
                    company: {
                        name: '',
                        vatNumber: '',
                        address: '',
                        email: '',
                        phone: '',
                        logo: null
                    },
                    trCodes: {
                        input: ['CASH', 'JC', 'JNL', 'SINV', 'JD', 'RC'],
                        output: ['IS', 'INV', 'RTS']
                    },
                    preferences: {
                        dateFormat: 'yyyy-mm-dd',
                        currencyFormat: 'R #,##0.00',
                        timezone: 'Africa/Johannesburg',
                        language: 'en'
                    },
                    storage: {
                        autoSave: true,
                        saveHistory: true,
                        dataRetention: 12
                    }
                };

                const saved = localStorage.getItem('vatCalculatorSettings');
                return saved ? { ...defaultSettings, ...JSON.parse(saved) } : defaultSettings;
            }

            saveSettings() {
                localStorage.setItem('vatCalculatorSettings', JSON.stringify(this.settings));
                this.showToast('Settings saved successfully', 'success');
            }

            initializeSettings() {
                setTimeout(() => {
                    // Company Info
                    const companyName = document.getElementById('companyName');
                    const vatNumber = document.getElementById('vatNumber');
                    const companyAddress = document.getElementById('companyAddress');
                    const companyEmail = document.getElementById('companyEmail');
                    const companyPhone = document.getElementById('companyPhone');

                    if (companyName) companyName.value = this.settings.company.name;
                    if (vatNumber) vatNumber.value = this.settings.company.vatNumber;
                    if (companyAddress) companyAddress.value = this.settings.company.address;
                    if (companyEmail) companyEmail.value = this.settings.company.email;
                    if (companyPhone) companyPhone.value = this.settings.company.phone;

                    // Preferences
                    const dateFormat = document.getElementById('dateFormat');
                    const currencyFormat = document.getElementById('currencyFormat');
                    const timezone = document.getElementById('timezone');
                    const language = document.getElementById('language');

                    if (dateFormat) dateFormat.value = this.settings.preferences.dateFormat;
                    if (currencyFormat) currencyFormat.value = this.settings.preferences.currencyFormat;
                    if (timezone) timezone.value = this.settings.preferences.timezone;
                    if (language) language.value = this.settings.preferences.language;

                    // Storage
                    const autoSave = document.getElementById('autoSave');
                    const saveHistory = document.getElementById('saveHistory');
                    const dataRetention = document.getElementById('dataRetention');

                    if (autoSave) autoSave.checked = this.settings.storage.autoSave;
                    if (saveHistory) saveHistory.checked = this.settings.storage.saveHistory;
                    if (dataRetention) dataRetention.value = this.settings.storage.dataRetention;

                    // TR Codes
                    this.renderTrCodes();
                }, 100);
            }

            renderTrCodes() {
                const inputCodes = document.getElementById('inputCodeItems');
                const outputCodes = document.getElementById('outputCodeItems');

                if (inputCodes) {
                    inputCodes.innerHTML = this.settings.trCodes.input.map(code => 
                        `<div class="code-item input">
                            <span class="code-name">${code}</span>
                            <button class="code-remove" onclick="settingsManager.removeTrCode('input', '${code}')">×</button>
                        </div>`
                    ).join('');
                }

                if (outputCodes) {
                    outputCodes.innerHTML = this.settings.trCodes.output.map(code => 
                        `<div class="code-item output">
                            <span class="code-name">${code}</span>
                            <button class="code-remove" onclick="settingsManager.removeTrCode('output', '${code}')">×</button>
                        </div>`
                    ).join('');
                }
            }

            addTrCode(type) {
                const input = document.getElementById(`add${type.charAt(0).toUpperCase() + type.slice(1)}Code`);
                if (!input) return;
                
                const code = input.value.trim().toUpperCase();
                
                if (code && !this.settings.trCodes[type].includes(code)) {
                    this.settings.trCodes[type].push(code);
                    this.renderTrCodes();
                    input.value = '';
                }
            }

            removeTrCode(type, code) {
                this.settings.trCodes[type] = this.settings.trCodes[type].filter(c => c !== code);
                this.renderTrCodes();
            }

            updateCompanyInfo() {
                const companyName = document.getElementById('companyName');
                const vatNumber = document.getElementById('vatNumber');
                const companyAddress = document.getElementById('companyAddress');
                const companyEmail = document.getElementById('companyEmail');
                const companyPhone = document.getElementById('companyPhone');

                if (companyName) this.settings.company.name = companyName.value;
                if (vatNumber) this.settings.company.vatNumber = vatNumber.value;
                if (companyAddress) this.settings.company.address = companyAddress.value;
                if (companyEmail) this.settings.company.email = companyEmail.value;
                if (companyPhone) this.settings.company.phone = companyPhone.value;
            }

            updatePreferences() {
                const dateFormat = document.getElementById('dateFormat');
                const currencyFormat = document.getElementById('currencyFormat');
                const timezone = document.getElementById('timezone');
                const language = document.getElementById('language');

                if (dateFormat) this.settings.preferences.dateFormat = dateFormat.value;
                if (currencyFormat) this.settings.preferences.currencyFormat = currencyFormat.value;
                if (timezone) this.settings.preferences.timezone = timezone.value;
                if (language) this.settings.preferences.language = language.value;
            }

            updateStorage() {
                const autoSave = document.getElementById('autoSave');
                const saveHistory = document.getElementById('saveHistory');
                const dataRetention = document.getElementById('dataRetention');

                if (autoSave) this.settings.storage.autoSave = autoSave.checked;
                if (saveHistory) this.settings.storage.saveHistory = saveHistory.checked;
                if (dataRetention) this.settings.storage.dataRetention = parseInt(dataRetention.value);
            }

            resetSettings() {
                if (confirm('Are you sure you want to reset all settings to default? This cannot be undone.')) {
                    localStorage.removeItem('vatCalculatorSettings');
                    location.reload();
                }
            }

            clearData() {
                if (confirm('Are you sure you want to clear all stored data? This will remove all calculation history and cannot be undone.')) {
                    localStorage.removeItem('vatCalculatorHistory');
                    this.showToast('All data cleared successfully', 'success');
                }
            }

            showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => toast.classList.add('show'), 100);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => document.body.removeChild(toast), 300);
                }, 3000);
            }

            handleLogoUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.settings.company.logo = e.target.result;
                        const logoPreview = document.getElementById('logoPreview');
                        if (logoPreview) {
                            logoPreview.innerHTML = 
                                `<img src="${e.target.result}" alt="Company Logo" style="max-width: 200px; max-height: 100px; border-radius: 8px;">`;
                        }
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        // Export Manager
        class ExportManager {
            constructor() {
                this.currentData = null;
            }

            setData(data) {
                this.currentData = data;
            }

            async exportToPDF() {
                if (!this.currentData) {
                    this.showToast('No data to export', 'error');
                    return;
                }

                try {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF();
                    
                    // Header
                    pdf.setFontSize(20);
                    pdf.text('VAT Calculation Report', 20, 20);
                    
                    pdf.setFontSize(12);
                    pdf.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 30);
                    
                    // Summary
                    pdf.setFontSize(16);
                    pdf.text('Summary', 20, 50);
                    
                    pdf.setFontSize(12);
                    pdf.text(`Total Input VAT: R ${this.currentData.totalInputVAT.toFixed(2)}`, 20, 65);
                    pdf.text(`Total Output VAT: R ${this.currentData.totalOutputVAT.toFixed(2)}`, 20, 75);
                    pdf.text(`VAT Payable: R ${this.currentData.vatPayable.toFixed(2)}`, 20, 85);
                    
                    // Breakdown
                    pdf.setFontSize(16);
                    pdf.text('Breakdown', 20, 105);
                    
                    let yPos = 120;
                    pdf.setFontSize(10);
                    
                    Object.entries(this.currentData.breakdown).forEach(([code, data]) => {
                        pdf.text(`${code}: R ${data.total.toFixed(2)} (${data.count} transactions)`, 20, yPos);
                        yPos += 10;
                    });
                    
                    pdf.save(`VAT_Report_${new Date().toISOString().split('T')[0]}.pdf`);
                    this.showToast('PDF exported successfully', 'success');
                } catch (error) {
                    this.showToast('Error exporting PDF: ' + error.message, 'error');
                }
            }

            exportToExcel() {
                if (!this.currentData) {
                    this.showToast('No data to export', 'error');
                    return;
                }

                try {
                    const wb = XLSX.utils.book_new();
                    
                    // Summary sheet
                    const summaryData = [
                        ['VAT Calculation Summary'],
                        ['Generated', new Date().toLocaleDateString()],
                        [''],
                        ['Total Input VAT', this.currentData.totalInputVAT],
                        ['Total Output VAT', this.currentData.totalOutputVAT],
                        ['VAT Payable', this.currentData.vatPayable],
                        [''],
                        ['Breakdown by TR Code'],
                        ['TR Code', 'Total Amount', 'Transaction Count']
                    ];
                    
                    Object.entries(this.currentData.breakdown).forEach(([code, data]) => {
                        summaryData.push([code, data.total, data.count]);
                    });
                    
                    const summaryWS = XLSX.utils.aoa_to_sheet(summaryData);
                    XLSX.utils.book_append_sheet(wb, summaryWS, 'Summary');
                    
                    // Raw data sheet
                    if (this.currentData.transactions) {
                        const dataWS = XLSX.utils.json_to_sheet(this.currentData.transactions);
                        XLSX.utils.book_append_sheet(wb, dataWS, 'Transactions');
                    }
                    
                    XLSX.writeFile(wb, `VAT_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
                    this.showToast('Excel file exported successfully', 'success');
                } catch (error) {
                    this.showToast('Error exporting Excel: ' + error.message, 'error');
                }
            }

            shareByEmail() {
                if (!this.currentData) {
                    this.showToast('No data to export', 'error');
                    return;
                }

                const subject = `VAT Calculation Report - ${new Date().toLocaleDateString()}`;
                const body = `VAT Calculation Summary:

Total Input VAT: R ${this.currentData.totalInputVAT.toFixed(2)}
Total Output VAT: R ${this.currentData.totalOutputVAT.toFixed(2)}
VAT Payable: R ${this.currentData.vatPayable.toFixed(2)}

Generated by VAT Calculator Pro`;

                const mailto = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.open(mailto);
            }

            printReport() {
                window.print();
            }

            showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => toast.classList.add('show'), 100);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => document.body.removeChild(toast), 300);
                }, 3000);
            }
        }

        // History Manager
        class HistoryManager {
            constructor() {
                this.history = this.loadHistory();
                this.initializeHistory();
            }

            loadHistory() {
                const saved = localStorage.getItem('vatCalculatorHistory');
                return saved ? JSON.parse(saved) : [];
            }

            saveHistory() {
                localStorage.setItem('vatCalculatorHistory', JSON.stringify(this.history));
            }

            addCalculation(data) {
                const calculation = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    filename: data.filename || 'Manual Entry',
                    totalInputVAT: data.totalInputVAT,
                    totalOutputVAT: data.totalOutputVAT,
                    vatPayable: data.vatPayable,
                    transactionCount: data.transactionCount || 0,
                    breakdown: data.breakdown
                };

                this.history.unshift(calculation);
                
                // Keep only last 100 calculations
                if (this.history.length > 100) {
                    this.history = this.history.slice(0, 100);
                }

                this.saveHistory();
                this.renderHistory();
                this.updateStats();
            }

            initializeHistory() {
                setTimeout(() => {
                    this.renderHistory();
                    this.updateStats();
                    this.initializeFilters();
                }, 100);
            }

            renderHistory() {
                const historyList = document.getElementById('historyList');
                if (!historyList) return;

                if (this.history.length === 0) {
                    historyList.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6b7280;">No calculations found</div>';
                    return;
                }

                historyList.innerHTML = this.history.map(calc => `
                    <div class="history-item">
                        <div class="history-info">
                            <div class="history-title">${calc.filename}</div>
                            <div class="history-meta">
                                <span>📅 ${new Date(calc.timestamp).toLocaleDateString()}</span>
                                <span>📊 ${calc.transactionCount} transactions</span>
                            </div>
                        </div>
                        <div class="history-amount">R ${calc.vatPayable.toFixed(2)}</div>
                        <div class="history-actions-item">
                            <button class="btn-icon" onclick="historyManager.viewCalculation('${calc.id}')" title="View Details">👁️</button>
                            <button class="btn-icon" onclick="historyManager.exportCalculation('${calc.id}')" title="Export">📄</button>
                            <button class="btn-icon" onclick="historyManager.deleteCalculation('${calc.id}')" title="Delete">🗑️</button>
                        </div>
                    </div>
                `).join('');
            }

            updateStats() {
                const totalCalcs = document.getElementById('totalCalculations');
                const totalVAT = document.getElementById('totalVATProcessed');
                const avgVAT = document.getElementById('averageVAT');
                const lastCalc = document.getElementById('lastCalculation');

                if (totalCalcs) totalCalcs.textContent = this.history.length;
                
                if (this.history.length > 0) {
                    const totalVATAmount = this.history.reduce((sum, calc) => sum + calc.vatPayable, 0);
                    const avgVATAmount = totalVATAmount / this.history.length;
                    const lastCalculation = this.history[0];

                    if (totalVAT) totalVAT.textContent = `R ${totalVATAmount.toFixed(2)}`;
                    if (avgVAT) avgVAT.textContent = `R ${avgVATAmount.toFixed(2)}`;
                    if (lastCalc) lastCalc.textContent = new Date(lastCalculation.timestamp).toLocaleDateString();
                } else {
                    if (totalVAT) totalVAT.textContent = 'R 0.00';
                    if (avgVAT) avgVAT.textContent = 'R 0.00';
                    if (lastCalc) lastCalc.textContent = 'Never';
                }
            }

            initializeFilters() {
                const searchInput = document.getElementById('historySearch');
                const sortSelect = document.getElementById('historySort');

                if (searchInput) {
                    searchInput.addEventListener('input', () => this.filterHistory());
                }

                if (sortSelect) {
                    sortSelect.addEventListener('change', () => this.filterHistory());
                }
            }

            filterHistory() {
                const searchTerm = document.getElementById('historySearch')?.value.toLowerCase() || '';
                const sortBy = document.getElementById('historySort')?.value || 'date';

                let filtered = this.history.filter(calc => 
                    calc.filename.toLowerCase().includes(searchTerm) ||
                    calc.vatPayable.toString().includes(searchTerm)
                );

                // Sort
                switch (sortBy) {
                    case 'date':
                        filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                        break;
                    case 'amount':
                        filtered.sort((a, b) => b.vatPayable - a.vatPayable);
                        break;
                    case 'filename':
                        filtered.sort((a, b) => a.filename.localeCompare(b.filename));
                        break;
                }

                this.renderFilteredHistory(filtered);
            }

            renderFilteredHistory(filteredHistory) {
                const historyList = document.getElementById('historyList');
                if (!historyList) return;

                if (filteredHistory.length === 0) {
                    historyList.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6b7280;">No matching calculations found</div>';
                    return;
                }

                historyList.innerHTML = filteredHistory.map(calc => `
                    <div class="history-item">
                        <div class="history-info">
                            <div class="history-title">${calc.filename}</div>
                            <div class="history-meta">
                                <span>📅 ${new Date(calc.timestamp).toLocaleDateString()}</span>
                                <span>📊 ${calc.transactionCount} transactions</span>
                            </div>
                        </div>
                        <div class="history-amount">R ${calc.vatPayable.toFixed(2)}</div>
                        <div class="history-actions-item">
                            <button class="btn-icon" onclick="historyManager.viewCalculation('${calc.id}')" title="View Details">👁️</button>
                            <button class="btn-icon" onclick="historyManager.exportCalculation('${calc.id}')" title="Export">📄</button>
                            <button class="btn-icon" onclick="historyManager.deleteCalculation('${calc.id}')" title="Delete">🗑️</button>
                        </div>
                    </div>
                `).join('');
            }

            viewCalculation(id) {
                const calc = this.history.find(c => c.id == id);
                if (!calc) return;

                alert(`Calculation Details:
                
Filename: ${calc.filename}
Date: ${new Date(calc.timestamp).toLocaleDateString()}
Total Input VAT: R ${calc.totalInputVAT.toFixed(2)}
Total Output VAT: R ${calc.totalOutputVAT.toFixed(2)}
VAT Payable: R ${calc.vatPayable.toFixed(2)}
Transaction Count: ${calc.transactionCount}`);
            }

            exportCalculation(id) {
                const calc = this.history.find(c => c.id == id);
                if (!calc) return;

                exportManager.setData(calc);
                exportManager.exportToPDF();
            }

            deleteCalculation(id) {
                if (confirm('Are you sure you want to delete this calculation?')) {
                    this.history = this.history.filter(c => c.id != id);
                    this.saveHistory();
                    this.renderHistory();
                    this.updateStats();
                }
            }

            clearAllHistory() {
                if (confirm('Are you sure you want to clear all calculation history? This cannot be undone.')) {
                    this.history = [];
                    this.saveHistory();
                    this.renderHistory();
                    this.updateStats();
                }
            }

            exportAllHistory() {
                if (this.history.length === 0) {
                    alert('No history to export');
                    return;
                }

                try {
                    const wb = XLSX.utils.book_new();
                    
                    const historyData = [
                        ['Calculation History'],
                        ['Exported', new Date().toLocaleDateString()],
                        [''],
                        ['Filename', 'Date', 'Input VAT', 'Output VAT', 'VAT Payable', 'Transactions']
                    ];
                    
                    this.history.forEach(calc => {
                        historyData.push([
                            calc.filename,
                            new Date(calc.timestamp).toLocaleDateString(),
                            calc.totalInputVAT,
                            calc.totalOutputVAT,
                            calc.vatPayable,
                            calc.transactionCount
                        ]);
                    });
                    
                    const ws = XLSX.utils.aoa_to_sheet(historyData);
                    XLSX.utils.book_append_sheet(wb, ws, 'History');
                    
                    XLSX.writeFile(wb, `VAT_History_${new Date().toISOString().split('T')[0]}.xlsx`);
                    alert('History exported successfully');
                } catch (error) {
                    alert('Error exporting history: ' + error.message);
                }
            }
        }

        // Initialize managers
        let settingsManager, exportManager, historyManager;

        // Enhanced initialization with managers
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                settingsManager = new SettingsManager();
                exportManager = new ExportManager();
                historyManager = new HistoryManager();
            }, 500);
        });

        // Enhanced calculateVAT function to integrate with export and history
        const originalCalculateVAT = calculateVAT;
        function enhancedCalculateVAT(data, filename) {
            const result = originalCalculateVAT(data, filename);
            
            if (result && exportManager && historyManager) {
                // Set export data
                exportManager.setData({
                    ...result,
                    filename: filename,
                    transactions: data
                });

                // Add to history
                historyManager.addCalculation({
                    ...result,
                    filename: filename,
                    transactionCount: data.length
                });
            }
            
            return result;
        }

        // Replace the original function
        calculateVAT = enhancedCalculateVAT;
    </script>

    <!-- Detailed Export Manager -->
    <script>
        // Enhanced Export Manager with Detailed Reports
        class DetailedExportManager {
            constructor() {
                this.currentData = null;
                this.currentTransactions = null;
                this.currentFilename = '';
                this.reportTemplate = null;
                this.initializeExportSystem();
            }

            initializeExportSystem() {
                // Add advanced export buttons to existing toolbar with delay for DOM readiness
                this.waitForDOMReady(() => {
                    this.enhanceExportToolbar();
                });
                
                // Setup report templates
                this.setupReportTemplates();
                
                // Setup export event listeners
                this.setupExportHandlers();
                
                // Check library availability
                this.checkLibraryAvailability();
            }

            waitForDOMReady(callback) {
                const checkForToolbar = () => {
                    const existingToolbar = document.querySelector('.export-toolbar');
                    if (existingToolbar) {
                        callback();
                    } else {
                        setTimeout(checkForToolbar, 500);
                    }
                };
                checkForToolbar();
            }

            checkLibraryAvailability() {
                setTimeout(() => {
                    const libraries = {
                        jsPDF: !!window.jspdf,
                        XLSX: !!window.XLSX
                    };
                    
                    console.log('Export libraries status:', libraries);
                    
                    if (!libraries.jsPDF) {
                        console.warn('jsPDF library not available - PDF exports will be disabled');
                    }
                    if (!libraries.XLSX) {
                        console.warn('XLSX library not available - Excel exports will be disabled');
                    }
                }, 2000);
            }

            enhanceExportToolbar() {
                const existingToolbar = document.querySelector('.export-toolbar');
                if (existingToolbar) {
                    // Add detailed export section
                    const detailedExportSection = document.createElement('div');
                    detailedExportSection.className = 'detailed-export-section';
                    detailedExportSection.innerHTML = `
                        <div class="export-section-title">📊 Detailed Reports</div>
                        <div class="detailed-export-buttons">
                            <button class="btn btn-export detailed-pdf" onclick="if(window.detailedExportManager) window.detailedExportManager.exportDetailedPDF(); else alert('Export system not ready. Please try again.');" title="Detailed PDF Report with Complete Analysis">
                                📄 Detailed PDF Report
                            </button>
                            <button class="btn btn-export comprehensive-excel" onclick="if(window.detailedExportManager) window.detailedExportManager.exportComprehensiveExcel(); else alert('Export system not ready. Please try again.');" title="Complete Excel Analysis with All Data">
                                📊 Complete Excel Analysis
                            </button>
                            <button class="btn btn-export tax-breakdown" onclick="if(window.detailedExportManager) window.detailedExportManager.exportTaxCodeBreakdown(); else alert('Export system not ready. Please try again.');" title="Tax Code Breakdown Report">
                                🔍 Tax Code Analysis
                            </button>
                            <button class="btn btn-export transaction-details" onclick="if(window.detailedExportManager) window.detailedExportManager.exportTransactionDetails(); else alert('Export system not ready. Please try again.');" title="Full Transaction Details">
                                📋 Transaction Details
                            </button>
                        </div>
                        <div class="export-options">
                            <label class="export-option">
                                <input type="checkbox" id="include-samples" checked>
                                Include sample transactions
                            </label>
                            <label class="export-option">
                                <input type="checkbox" id="include-charts" checked>
                                Include visual charts
                            </label>
                            <label class="export-option">
                                <input type="checkbox" id="include-analysis" checked>
                                Include detailed analysis
                            </label>
                        </div>
                    `;
                    
                    existingToolbar.appendChild(detailedExportSection);
                }
            }

            setData(data) {
                this.currentData = data;
                this.currentTransactions = data.transactions || [];
                this.currentFilename = data.filename || 'VAT_Analysis';
                console.log('Detailed Export Manager: Data set successfully');
            }

            // COMPREHENSIVE PDF EXPORT WITH FULL DETAILS
            async exportDetailedPDF() {
                if (!this.currentData) {
                    this.showError('No calculation data available for export', 'Please process a VAT calculation first.');
                    return;
                }

                try {
                    // Check if jsPDF is available
                    if (!window.jspdf) {
                        throw new Error('PDF library not loaded. Please refresh the page and try again.');
                    }

                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    let yPos = 20;
                    const pageHeight = 280;
                    const leftMargin = 20;
                    const rightMargin = 190;
                    
                    // Enhanced styling
                    pdf.setFont('helvetica');
                    
                    // HEADER SECTION
                    pdf.setFontSize(22);
                    pdf.setTextColor(70, 130, 180);
                    pdf.text('VAT CALCULATOR PRO', leftMargin, yPos);
                    
                    pdf.setFontSize(18);
                    pdf.setTextColor(0, 0, 0);
                    yPos += 10;
                    pdf.text('Comprehensive VAT Analysis Report', leftMargin, yPos);
                    
                    // Report metadata
                    pdf.setFontSize(10);
                    pdf.setTextColor(100, 100, 100);
                    yPos += 8;
                    pdf.text(`Generated: ${new Date().toLocaleString()}`, leftMargin, yPos);
                    yPos += 5;
                    pdf.text(`Source File: ${this.currentFilename}`, leftMargin, yPos);
                    yPos += 5;
                    pdf.text(`Total Transactions: ${this.currentTransactions.length.toLocaleString()}`, leftMargin, yPos);
                    
                    // Separator line
                    yPos += 10;
                    pdf.setLineWidth(0.5);
                    pdf.line(leftMargin, yPos, rightMargin, yPos);
                    yPos += 15;

                    // EXECUTIVE SUMMARY SECTION
                    pdf.setFontSize(16);
                    pdf.setTextColor(0, 0, 0);
                    pdf.text('📋 EXECUTIVE SUMMARY', leftMargin, yPos);
                    yPos += 10;
                    
                    // Summary box
                    pdf.setDrawColor(70, 130, 180);
                    pdf.setLineWidth(0.3);
                    pdf.rect(leftMargin, yPos - 5, rightMargin - leftMargin, 35);
                    
                    pdf.setFontSize(12);
                    pdf.setTextColor(0, 0, 0);
                    yPos += 5;
                    pdf.text(`Total Input VAT (Purchases):`, leftMargin + 5, yPos);
                    pdf.text(`R ${this.formatCurrency(this.currentData.totalInputVAT)}`, 120, yPos);
                    
                    yPos += 7;
                    pdf.text(`Total Output VAT (Sales):`, leftMargin + 5, yPos);
                    pdf.text(`R ${this.formatCurrency(this.currentData.totalOutputVAT)}`, 120, yPos);
                    
                    yPos += 7;
                    pdf.setFont('helvetica', 'bold');
                    const vatPayableLabel = this.currentData.vatPayable >= 0 ? 'VAT Payable:' : 'VAT Refund:';
                    pdf.text(vatPayableLabel, leftMargin + 5, yPos);
                    pdf.text(`R ${this.formatCurrency(Math.abs(this.currentData.vatPayable))}`, 120, yPos);
                    
                    yPos += 7;
                    pdf.setFont('helvetica', 'normal');
                    pdf.text(`Sales Excluding VAT:`, leftMargin + 5, yPos);
                    pdf.text(`R ${this.formatCurrency(this.currentData.salesExcludingVAT)}`, 120, yPos);
                    
                    yPos += 15;

                    // TAX CODE BREAKDOWN SECTIONS
                    for (const [taxCode, breakdown] of Object.entries(this.currentData.taxCodeBreakdown)) {
                        // Skip empty tax codes
                        if (breakdown.input.count === 0 && breakdown.output.count === 0) {
                            continue;
                        }

                        // Check if we need a new page
                        if (yPos > pageHeight - 60) {
                            pdf.addPage();
                            yPos = 20;
                        }

                        // Tax Code Header
                        pdf.setFontSize(14);
                        pdf.setTextColor(106, 90, 205);
                        pdf.text(`Tax Code ${taxCode}: ${breakdown.description} (${breakdown.rate}%)`, leftMargin, yPos);
                        yPos += 10;

                        // Input VAT Section
                        if (breakdown.input.count > 0) {
                            pdf.setFontSize(12);
                            pdf.setTextColor(220, 20, 60);
                            pdf.text('📥 INPUT VAT (Purchases)', leftMargin + 5, yPos);
                            yPos += 8;
                            
                            pdf.setFontSize(10);
                            pdf.setTextColor(0, 0, 0);
                            pdf.text(`Transactions: ${breakdown.input.count.toLocaleString()}`, leftMargin + 10, yPos);
                            pdf.text(`VAT Amount: R ${this.formatCurrency(breakdown.input.vatAmount)}`, 100, yPos);
                            yPos += 5;
                            pdf.text(`Excl Amount: R ${this.formatCurrency(breakdown.input.exclAmount)}`, leftMargin + 10, yPos);
                            yPos += 8;

                            // Sample input transactions
                            if (breakdown.input.transactions.length > 0 && document.getElementById('include-samples')?.checked !== false) {
                                pdf.setFontSize(9);
                                pdf.setTextColor(100, 100, 100);
                                pdf.text('Sample Input Transactions:', leftMargin + 10, yPos);
                                yPos += 5;

                                breakdown.input.transactions.slice(0, 5).forEach((transaction, index) => {
                                    const sampleText = `${transaction.TrCode}: R ${this.formatNumber(transaction.ExclAmount)} (VAT: R ${this.formatNumber(transaction.TaxAmount)})`;
                                    pdf.text(`• ${sampleText}`, leftMargin + 15, yPos);
                                    yPos += 4;
                                });
                                yPos += 3;
                            }
                        }

                        // Output VAT Section
                        if (breakdown.output.count > 0) {
                            pdf.setFontSize(12);
                            pdf.setTextColor(30, 144, 255);
                            pdf.text('📤 OUTPUT VAT (Sales)', leftMargin + 5, yPos);
                            yPos += 8;
                            
                            pdf.setFontSize(10);
                            pdf.setTextColor(0, 0, 0);
                            pdf.text(`Transactions: ${breakdown.output.count.toLocaleString()}`, leftMargin + 10, yPos);
                            pdf.text(`VAT Amount: R ${this.formatCurrency(breakdown.output.vatAmount)}`, 100, yPos);
                            yPos += 5;
                            pdf.text(`Excl Amount: R ${this.formatCurrency(breakdown.output.exclAmount)}`, leftMargin + 10, yPos);
                            yPos += 8;

                            // Sample output transactions
                            if (breakdown.output.transactions.length > 0 && document.getElementById('include-samples')?.checked !== false) {
                                pdf.setFontSize(9);
                                pdf.setTextColor(100, 100, 100);
                                pdf.text('Sample Output Transactions:', leftMargin + 10, yPos);
                                yPos += 5;

                                breakdown.output.transactions.slice(0, 5).forEach((transaction, index) => {
                                    const sampleText = `${transaction.TrCode}: R ${this.formatNumber(transaction.ExclAmount)} (VAT: R ${this.formatNumber(transaction.TaxAmount)})`;
                                    pdf.text(`• ${sampleText}`, leftMargin + 15, yPos);
                                    yPos += 4;
                                });
                                yPos += 3;
                            }
                        }

                        // Separator
                        yPos += 5;
                        pdf.setDrawColor(200, 200, 200);
                        pdf.setLineWidth(0.2);
                        pdf.line(leftMargin, yPos, rightMargin, yPos);
                        yPos += 10;
                    }

                    // DETAILED ANALYSIS SECTION (if enabled)
                    if (document.getElementById('include-analysis')?.checked !== false) {
                        if (yPos > pageHeight - 40) {
                            pdf.addPage();
                            yPos = 20;
                        }

                        pdf.setFontSize(16);
                        pdf.setTextColor(0, 0, 0);
                        pdf.text('🔍 DETAILED ANALYSIS', leftMargin, yPos);
                        yPos += 15;

                        // Transaction Code Analysis
                        const trCodeStats = this.generateTransactionCodeStats();
                        pdf.setFontSize(12);
                        pdf.text('Transaction Code Distribution:', leftMargin, yPos);
                        yPos += 8;

                        pdf.setFontSize(10);
                        Object.entries(trCodeStats).forEach(([code, stats]) => {
                            pdf.text(`${code}: ${stats.count} transactions (R ${this.formatCurrency(stats.total)})`, leftMargin + 5, yPos);
                            yPos += 5;
                        });

                        yPos += 10;

                        // VAT Rate Analysis
                        pdf.setFontSize(12);
                        pdf.text('VAT Rate Breakdown:', leftMargin, yPos);
                        yPos += 8;

                        const rateAnalysis = this.generateVATRateAnalysis();
                        pdf.setFontSize(10);
                        Object.entries(rateAnalysis).forEach(([rate, data]) => {
                            pdf.text(`${rate}% Rate: ${data.transactions} transactions (Total: R ${this.formatCurrency(data.amount)})`, leftMargin + 5, yPos);
                            yPos += 5;
                        });
                    }

                    // Footer with page numbers
                    const pageCount = pdf.internal.getNumberOfPages();
                    for (let i = 1; i <= pageCount; i++) {
                        pdf.setPage(i);
                        pdf.setFontSize(8);
                        pdf.setTextColor(100, 100, 100);
                        pdf.text(`Page ${i} of ${pageCount}`, rightMargin - 30, 290);
                        pdf.text('Generated by VAT Calculator Pro', leftMargin, 290);
                    }

                    // Save the PDF
                    const filename = `VAT_Detailed_Report_${this.currentFilename}_${new Date().toISOString().split('T')[0]}.pdf`;
                    pdf.save(filename);
                    
                    this.showExportSuccess('Detailed PDF report exported successfully');

                } catch (error) {
                    console.error('Detailed PDF export error:', error);
                    this.showError('Error generating detailed PDF report', error.message);
                    if (window.errorHandler) {
                        window.errorHandler.logError({
                            type: 'Export Error',
                            message: 'Failed to generate detailed PDF report',
                            stack: error.stack,
                            timestamp: new Date().toISOString()
                        });
                    }
                }
            }

            // COMPREHENSIVE EXCEL EXPORT WITH MULTIPLE SHEETS
            exportComprehensiveExcel() {
                if (!this.currentData) {
                    this.showError('No calculation data available for export', 'Please process a VAT calculation first.');
                    return;
                }

                try {
                    // Check if XLSX is available
                    if (!window.XLSX) {
                        throw new Error('Excel library not loaded. Please refresh the page and try again.');
                    }
                    const wb = XLSX.utils.book_new();

                    // SHEET 1: Executive Summary
                    const summaryData = [
                        ['VAT CALCULATOR PRO - COMPREHENSIVE ANALYSIS'],
                        [`Generated: ${new Date().toLocaleString()}`],
                        [`Source File: ${this.currentFilename}`],
                        [`Total Transactions: ${this.currentTransactions.length.toLocaleString()}`],
                        [''],
                        ['EXECUTIVE SUMMARY'],
                        ['Metric', 'Amount (R)'],
                        ['Total Input VAT (Purchases)', this.currentData.totalInputVAT],
                        ['Total Output VAT (Sales)', this.currentData.totalOutputVAT],
                        ['VAT Payable/Refund', this.currentData.vatPayable],
                        ['Sales Excluding VAT', this.currentData.salesExcludingVAT],
                        ['Sales Including VAT', this.currentData.salesIncludingVAT],
                        ['Zero-Rated Sales', this.currentData.zeroRatedSales],
                        [''],
                        ['BREAKDOWN BY TAX CODE'],
                        ['Tax Code', 'Description', 'Rate %', 'Input Count', 'Input VAT', 'Input Excl', 'Output Count', 'Output VAT', 'Output Excl']
                    ];

                    // Add tax code breakdown data
                    Object.entries(this.currentData.taxCodeBreakdown).forEach(([code, breakdown]) => {
                        if (breakdown.input.count > 0 || breakdown.output.count > 0) {
                            summaryData.push([
                                code,
                                breakdown.description,
                                breakdown.rate,
                                breakdown.input.count,
                                breakdown.input.vatAmount,
                                breakdown.input.exclAmount,
                                breakdown.output.count,
                                breakdown.output.vatAmount,
                                breakdown.output.exclAmount
                            ]);
                        }
                    });

                    const summaryWS = XLSX.utils.aoa_to_sheet(summaryData);
                    // Style the summary sheet
                    summaryWS['!cols'] = [
                        { wch: 25 }, { wch: 15 }, { wch: 10 }, { wch: 12 }, { wch: 15 }, 
                        { wch: 15 }, { wch: 12 }, { wch: 15 }, { wch: 15 }
                    ];
                    XLSX.utils.book_append_sheet(wb, summaryWS, 'Executive Summary');

                    // SHEET 2: Tax Code Details
                    const taxCodeData = [['TAX CODE DETAILED BREAKDOWN'], ['']];

                    Object.entries(this.currentData.taxCodeBreakdown).forEach(([code, breakdown]) => {
                        if (breakdown.input.count > 0 || breakdown.output.count > 0) {
                            taxCodeData.push([`TAX CODE ${code}: ${breakdown.description} (${breakdown.rate}%)`]);
                            taxCodeData.push(['']);

                            if (breakdown.input.count > 0) {
                                taxCodeData.push(['INPUT VAT (Purchases)']);
                                taxCodeData.push(['Transactions', 'VAT Amount', 'Excl Amount']);
                                taxCodeData.push([breakdown.input.count, breakdown.input.vatAmount, breakdown.input.exclAmount]);
                                taxCodeData.push(['']);
                                
                                if (breakdown.input.transactions.length > 0) {
                                    taxCodeData.push(['All Input Transactions']);
                                    taxCodeData.push(['TR Code', 'TxDate', 'Reference', 'VAT Amount', 'Excl Amount', 'Incl Amount', 'Description']);
                                    breakdown.input.transactions.forEach(tx => {
                                        taxCodeData.push([tx.TrCode, tx.TxDate || '', tx.Reference || '', tx.TaxAmount, tx.ExclAmount, tx.InclAmount, tx.TaxDescription]);
                                    });
                                    taxCodeData.push(['']);
                                }
                            }

                            if (breakdown.output.count > 0) {
                                taxCodeData.push(['OUTPUT VAT (Sales)']);
                                taxCodeData.push(['Transactions', 'VAT Amount', 'Excl Amount']);
                                taxCodeData.push([breakdown.output.count, breakdown.output.vatAmount, breakdown.output.exclAmount]);
                                taxCodeData.push(['']);
                                
                                if (breakdown.output.transactions.length > 0) {
                                    taxCodeData.push(['All Output Transactions']);
                                    taxCodeData.push(['TR Code', 'TxDate', 'Reference', 'VAT Amount', 'Excl Amount', 'Incl Amount', 'Description']);
                                    breakdown.output.transactions.forEach(tx => {
                                        taxCodeData.push([tx.TrCode, tx.TxDate || '', tx.Reference || '', tx.TaxAmount, tx.ExclAmount, tx.InclAmount, tx.TaxDescription]);
                                    });
                                    taxCodeData.push(['']);
                                }
                            }
                            taxCodeData.push(['', '', '', '']); // Spacer
                        }
                    });

                    const taxCodeWS = XLSX.utils.aoa_to_sheet(taxCodeData);
                    taxCodeWS['!cols'] = [{ wch: 20 }, { wch: 12 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 30 }];
                    XLSX.utils.book_append_sheet(wb, taxCodeWS, 'Tax Code Details');

                    // SHEET 3: Transaction Analysis
                    const analysisData = [
                        ['TRANSACTION ANALYSIS'],
                        [''],
                        ['Transaction Code Distribution'],
                        ['TR Code', 'Count', 'Total Amount', 'Average Amount', 'Type']
                    ];

                    const trCodeStats = this.generateTransactionCodeStats();
                    Object.entries(trCodeStats).forEach(([code, stats]) => {
                        const type = ['CASH', 'JC', 'JNL', 'SINV', 'JD', 'RC'].includes(code) ? 'INPUT' : 'OUTPUT';
                        analysisData.push([code, stats.count, stats.total, stats.total / stats.count, type]);
                    });

                    analysisData.push(['']);
                    analysisData.push(['VAT Rate Analysis']);
                    analysisData.push(['Rate %', 'Transactions', 'Total Amount', 'VAT Amount']);

                    const rateAnalysis = this.generateVATRateAnalysis();
                    Object.entries(rateAnalysis).forEach(([rate, data]) => {
                        analysisData.push([rate, data.transactions, data.amount, data.vat]);
                    });

                    const analysisWS = XLSX.utils.aoa_to_sheet(analysisData);
                    analysisWS['!cols'] = [{ wch: 15 }, { wch: 12 }, { wch: 15 }, { wch: 15 }, { wch: 10 }];
                    XLSX.utils.book_append_sheet(wb, analysisWS, 'Transaction Analysis');

                    // SHEET 4: All Transactions (if data available)
                    if (this.currentTransactions && this.currentTransactions.length > 0) {
                        // Enhanced transaction data with Input/Output classification
                        const enhancedTransactions = this.currentTransactions.map(tx => ({
                            ...tx,
                            TransactionType: this.getTransactionType(tx.TrCode),
                            VATCategory: this.getVATCategory(tx.TaxCode)
                        }));
                        
                        const transactionWS = XLSX.utils.json_to_sheet(enhancedTransactions);
                        XLSX.utils.book_append_sheet(wb, transactionWS, 'All Transactions');
                    }

                    // SHEET 5: SARS Compliance Summary
                    const complianceData = [
                        ['SARS VAT RETURN SUMMARY'],
                        [''],
                        ['Output VAT (Box 1-9)'],
                        ['Description', 'Amount (R)'],
                        ['Standard-rated supplies', this.getStandardRatedOutputVAT()],
                        ['Zero-rated supplies', this.currentData.zeroRatedSales],
                        ['Exempt supplies', this.getExemptOutputVAT()],
                        ['Total Output VAT', this.currentData.totalOutputVAT],
                        [''],
                        ['Input VAT (Box 10-19)'],
                        ['Description', 'Amount (R)'],
                        ['Standard-rated purchases', this.getStandardRatedInputVAT()],
                        ['Capital goods purchases', this.getCapitalGoodsVAT()],
                        ['Total Input VAT', this.currentData.totalInputVAT],
                        [''],
                        ['Net VAT Calculation'],
                        ['Total Output VAT', this.currentData.totalOutputVAT],
                        ['Less: Total Input VAT', this.currentData.totalInputVAT],
                        ['Net VAT Amount', this.currentData.vatPayable]
                    ];

                    const complianceWS = XLSX.utils.aoa_to_sheet(complianceData);
                    complianceWS['!cols'] = [{ wch: 30 }, { wch: 15 }];
                    XLSX.utils.book_append_sheet(wb, complianceWS, 'SARS Compliance');

                    // Save the comprehensive Excel file
                    const filename = `VAT_Comprehensive_Analysis_${this.currentFilename}_${new Date().toISOString().split('T')[0]}.xlsx`;
                    XLSX.writeFile(wb, filename);
                    
                    this.showExportSuccess('Comprehensive Excel analysis exported successfully');

                } catch (error) {
                    console.error('Comprehensive Excel export error:', error);
                    this.showError('Error generating comprehensive Excel report', error.message);
                    if (window.errorHandler) {
                        window.errorHandler.logError({
                            type: 'Export Error',
                            message: 'Failed to generate comprehensive Excel report',
                            stack: error.stack,
                            timestamp: new Date().toISOString()
                        });
                    }
                }
            }

            // TAX CODE BREAKDOWN EXPORT
            exportTaxCodeBreakdown() {
                if (!this.currentData) {
                    this.showError('No calculation data available for export', 'Please process a VAT calculation first.');
                    return;
                }

                try {
                    // Check if XLSX is available
                    if (!window.XLSX) {
                        throw new Error('Excel library not loaded. Please refresh the page and try again.');
                    }
                    const wb = XLSX.utils.book_new();
                    
                    Object.entries(this.currentData.taxCodeBreakdown).forEach(([taxCode, breakdown]) => {
                        if (breakdown.input.count === 0 && breakdown.output.count === 0) return;

                        const sheetData = [
                            [`TAX CODE ${taxCode}: ${breakdown.description}`],
                            [`Rate: ${breakdown.rate}%`],
                            [''],
                            ['INPUT VAT (Purchases)'],
                            ['Metric', 'Value'],
                            ['Transaction Count', breakdown.input.count],
                            ['VAT Amount', breakdown.input.vatAmount],
                            ['Excluding VAT Amount', breakdown.input.exclAmount],
                            [''],
                            ['OUTPUT VAT (Sales)'],
                            ['Metric', 'Value'],
                            ['Transaction Count', breakdown.output.count],
                            ['VAT Amount', breakdown.output.vatAmount],
                            ['Excluding VAT Amount', breakdown.output.exclAmount],
                            [''],
                            ['SAMPLE TRANSACTIONS']
                        ];

                        if (breakdown.input.transactions.length > 0) {
                            sheetData.push(['Input Transaction Samples']);
                            sheetData.push(['TR Code', 'TxDate', 'Reference', 'VAT Amount', 'Excl Amount', 'Description']);
                            breakdown.input.transactions.forEach(tx => {
                                sheetData.push([tx.TrCode, tx.TxDate || '', tx.Reference || '', tx.TaxAmount, tx.ExclAmount, tx.TaxDescription || '']);
                            });
                            sheetData.push(['']);
                        }

                        if (breakdown.output.transactions.length > 0) {
                            sheetData.push(['Output Transaction Samples']);
                            sheetData.push(['TR Code', 'TxDate', 'Reference', 'VAT Amount', 'Excl Amount', 'Description']);
                            breakdown.output.transactions.forEach(tx => {
                                sheetData.push([tx.TrCode, tx.TxDate || '', tx.Reference || '', tx.TaxAmount, tx.ExclAmount, tx.TaxDescription || '']);
                            });
                        }

                        const ws = XLSX.utils.aoa_to_sheet(sheetData);
                        ws['!cols'] = [{ wch: 20 }, { wch: 12 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 30 }];
                        XLSX.utils.book_append_sheet(wb, ws, `Tax Code ${taxCode}`);
                    });

                    const filename = `VAT_Tax_Code_Breakdown_${this.currentFilename}_${new Date().toISOString().split('T')[0]}.xlsx`;
                    XLSX.writeFile(wb, filename);
                    
                    this.showExportSuccess('Tax code breakdown exported successfully');

                } catch (error) {
                    console.error('Tax code breakdown export error:', error);
                    this.showError('Error generating tax code breakdown', error.message);
                    if (window.errorHandler) {
                        window.errorHandler.logError({
                            type: 'Export Error',
                            message: 'Failed to generate tax code breakdown',
                            stack: error.stack,
                            timestamp: new Date().toISOString()
                        });
                    }
                }
            }

            // FULL TRANSACTION DETAILS EXPORT
            exportTransactionDetails() {
                if (!this.currentTransactions || this.currentTransactions.length === 0) {
                    this.showError('No transaction data available for export', 'Please process a VAT calculation first.');
                    return;
                }

                try {
                    // Check if XLSX is available
                    if (!window.XLSX) {
                        throw new Error('Excel library not loaded. Please refresh the page and try again.');
                    }
                    const wb = XLSX.utils.book_new();
                    
                    // Debug: Log the first transaction to see available columns
                    if (this.currentTransactions.length > 0) {
                        console.log('Available transaction columns:', Object.keys(this.currentTransactions[0]));
                        console.log('Sample transaction:', this.currentTransactions[0]);
                    }
                    
                    // Enhanced transaction data with analysis and explicit column ordering
                    const enhancedTransactions = this.currentTransactions.map(tx => {
                        // Create ordered object with only requested columns plus original ones
                        const orderedTransaction = {
                            // Add only the requested columns: TxDate and Reference - preserve exactly as imported
                            TxDate: tx.TxDate || tx.txDate || tx.TransactionDate || tx.Date || '',
                            Reference: tx.Reference || tx.reference || tx.Ref || tx.RefNo || '',
                            
                            // Keep original export columns
                            TaxCode: tx.TaxCode || '',
                            TaxDescription: tx.TaxDescription || '',
                            TrCode: tx.TrCode || '',
                            TaxRate: tx.TaxRate || 0,
                            TaxAmount: tx.TaxAmount || 0,
                            ExclAmount: tx.ExclAmount || 0,
                            InclAmount: tx.InclAmount || 0,
                            
                            // Analysis columns
                            TransactionType: this.getTransactionType(tx.TrCode || tx.trCode),
                            VATCategory: this.getVATCategory(tx.TaxCode || tx.taxCode),
                            CalculatedVAT: parseFloat(((tx.ExclAmount || 0) * ((tx.TaxRate || 0) / 100)).toFixed(2)),
                            VATDifference: parseFloat(((tx.TaxAmount || 0) - ((tx.ExclAmount || 0) * ((tx.TaxRate || 0) / 100))).toFixed(2))
                        };

                        return orderedTransaction;
                    });

                    const transactionWS = XLSX.utils.json_to_sheet(enhancedTransactions);
                    
                    // Set column widths for simplified transaction data
                    transactionWS['!cols'] = [
                        { wch: 12 },  // TxDate
                        { wch: 15 },  // Reference
                        { wch: 10 },  // TaxCode
                        { wch: 25 },  // TaxDescription
                        { wch: 10 },  // TrCode
                        { wch: 10 },  // TaxRate
                        { wch: 15 },  // TaxAmount
                        { wch: 15 },  // ExclAmount
                        { wch: 15 },  // InclAmount
                        { wch: 15 },  // TransactionType
                        { wch: 20 },  // VATCategory
                        { wch: 15 },  // CalculatedVAT
                        { wch: 15 }   // VATDifference
                    ];
                    
                    XLSX.utils.book_append_sheet(wb, transactionWS, 'All Transactions');

                    const filename = `VAT_Transaction_Details_${this.currentFilename}_${new Date().toISOString().split('T')[0]}.xlsx`;
                    XLSX.writeFile(wb, filename);
                    
                    this.showExportSuccess('Transaction details exported successfully');

                } catch (error) {
                    console.error('Transaction details export error:', error);
                    this.showError('Error generating transaction details', error.message);
                    if (window.errorHandler) {
                        window.errorHandler.logError({
                            type: 'Export Error',
                            message: 'Failed to generate transaction details',
                            stack: error.stack,
                            timestamp: new Date().toISOString()
                        });
                    }
                }
            }

            // HELPER METHODS FOR ANALYSIS
            generateTransactionCodeStats() {
                const stats = {};
                
                this.currentTransactions.forEach(tx => {
                    if (!stats[tx.TrCode]) {
                        stats[tx.TrCode] = { count: 0, total: 0 };
                    }
                    stats[tx.TrCode].count++;
                    stats[tx.TrCode].total += tx.ExclAmount;
                });
                
                return stats;
            }

            generateVATRateAnalysis() {
                const analysis = {};
                
                this.currentTransactions.forEach(tx => {
                    const rate = tx.TaxRate;
                    if (!analysis[rate]) {
                        analysis[rate] = { transactions: 0, amount: 0, vat: 0 };
                    }
                    analysis[rate].transactions++;
                    analysis[rate].amount += tx.ExclAmount;
                    analysis[rate].vat += tx.TaxAmount;
                });
                
                return analysis;
            }

            getTransactionType(trCode) {
                return ['CASH', 'JC', 'JNL', 'SINV', 'JD', 'RC'].includes(trCode) ? 'INPUT' : 'OUTPUT';
            }

            getVATCategory(taxCode) {
                switch (taxCode) {
                    case '1': return 'Standard Rate (15%)';
                    case '3': return 'Zero Rate (0%)';
                    case '5': return 'Exempt (0%)';
                    default: return 'Unknown';
                }
            }

            getStandardRatedOutputVAT() {
                return this.currentData.taxCodeBreakdown['1']?.output?.vatAmount || 0;
            }

            getStandardRatedInputVAT() {
                return this.currentData.taxCodeBreakdown['1']?.input?.vatAmount || 0;
            }

            getExemptOutputVAT() {
                return this.currentData.taxCodeBreakdown['5']?.output?.vatAmount || 0;
            }

            getCapitalGoodsVAT() {
                // This would need to be determined from transaction descriptions or additional data
                return 0; // Placeholder
            }

            // UTILITY METHODS
            formatCurrency(amount) {
                return new Intl.NumberFormat('en-ZA', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(Math.abs(amount));
            }

            formatExcelDate(excelDate) {
                if (!excelDate || excelDate === '') return '';
                
                // If it's already a formatted date string from Excel, preserve it exactly
                if (typeof excelDate === 'string') {
                    // Check if it's in the format YYYY/MM/DD HH:MM:SS (from your Excel file)
                    if (excelDate.includes('/') && excelDate.includes(' ')) {
                        // Extract just the date part (before the space)
                        const datePart = excelDate.split(' ')[0];
                        return datePart; // Return as YYYY/MM/DD
                    }
                    // If it's already in another date format, return as-is
                    if (excelDate.includes('/') || excelDate.includes('-')) {
                        return excelDate;
                    }
                }
                
                // Only convert if it's actually a number (Excel serial date)
                if (typeof excelDate === 'number') {
                    // Excel serial date starts from January 1, 1900
                    const excelEpoch = new Date(1900, 0, 1);
                    const jsDate = new Date(excelEpoch.getTime() + (excelDate - 1) * 24 * 60 * 60 * 1000);
                    
                    // Format as YYYY/MM/DD to match your input format
                    return jsDate.toLocaleDateString('en-CA'); // en-CA gives YYYY-MM-DD, then replace - with /
                }
                
                return excelDate; // Return as-is if can't process
            }

            formatNumber(num) {
                return new Intl.NumberFormat('en-ZA', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(num);
            }

            showExportSuccess(message) {
                // Create success notification
                const notification = document.createElement('div');
                notification.className = 'export-success-notification';
                notification.innerHTML = `
                    <div class="success-content">
                        <div class="success-icon">✅</div>
                        <div class="success-message">${message}</div>
                    </div>
                `;
                
                // Style the notification
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 15px 25px;
                    border-radius: 10px;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                    z-index: 1000;
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    font-size: 14px;
                    max-width: 350px;
                    transition: all 0.3s ease;
                `;
                
                document.body.appendChild(notification);
                
                // Auto-remove after 4 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.style.opacity = '0';
                        notification.style.transform = 'translateX(100%)';
                        setTimeout(() => notification.remove(), 300);
                    }
                }, 4000);
            }

            showError(title, message) {
                // Create error notification
                const notification = document.createElement('div');
                notification.className = 'export-error-notification';
                notification.innerHTML = `
                    <div class="error-content">
                        <div class="error-icon">❌</div>
                        <div class="error-title">${title}</div>
                        <div class="error-message">${message}</div>
                        <button class="error-close" onclick="this.closest('.export-error-notification').remove()">×</button>
                    </div>
                `;
                
                // Style the notification
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
                    color: white;
                    padding: 15px 25px;
                    border-radius: 10px;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                    z-index: 1000;
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    font-size: 14px;
                    max-width: 400px;
                    transition: all 0.3s ease;
                `;
                
                document.body.appendChild(notification);
                
                // Auto-remove after 8 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.style.opacity = '0';
                        notification.style.transform = 'translateX(100%)';
                        setTimeout(() => notification.remove(), 300);
                    }
                }, 8000);
            }

            setupExportHandlers() {
                // Additional setup for export functionality
                console.log('Detailed Export Manager: Export handlers initialized');
            }

            setupReportTemplates() {
                // Initialize report templates for consistent formatting
                this.reportTemplate = {
                    colors: {
                        primary: '#667eea',
                        secondary: '#764ba2',
                        input: '#dc3545',
                        output: '#007bff',
                        success: '#28a745'
                    },
                    fonts: {
                        title: 18,
                        heading: 14,
                        subheading: 12,
                        body: 10,
                        small: 9
                    }
                };
            }
        }

        // Initialize the detailed export manager with proper timing
        window.detailedExportManager = null;

        // Initialize after DOM is ready and managers are set up
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                try {
                    window.detailedExportManager = new DetailedExportManager();
                    console.log('Detailed Export Manager initialized successfully');
                    
                    // Integrate with existing export manager if available
                    if (typeof exportManager !== 'undefined' && exportManager) {
                        const originalSetData = exportManager.setData;
                        exportManager.setData = function(data) {
                            originalSetData.call(this, data);
                            if (window.detailedExportManager) {
                                window.detailedExportManager.setData(data);
                            }
                        };
                        console.log('Detailed Export Manager integrated with existing export manager');
                    }
                } catch (error) {
                    console.error('Failed to initialize Detailed Export Manager:', error);
                    if (window.errorHandler) {
                        window.errorHandler.logError({
                            type: 'Initialization Error',
                            message: 'Failed to initialize detailed export manager',
                            stack: error.stack,
                            timestamp: new Date().toISOString()
                        });
                    }
                }
            }, 1500); // Give extra time for all managers to initialize
        });

        // Integrate with enhanced calculateVAT function
        const originalEnhancedCalculateVAT = calculateVAT;
        calculateVAT = function(data, filename) {
            const result = originalEnhancedCalculateVAT(data, filename);
            
            if (result && window.detailedExportManager) {
                try {
                    // Set detailed export data
                    window.detailedExportManager.setData({
                        ...result,
                        filename: filename,
                        transactions: data
                    });
                } catch (error) {
                    console.error('Error setting detailed export data:', error);
                }
            }
            
            return result;
        };
    </script>
</body>
</html>
